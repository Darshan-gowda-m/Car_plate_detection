{% extends "layout.html" %}

{% block title %}Batch Processing - Plate Detection{% endblock %}

{% block extra_css %}
<style>
/* ===== BATCH PROCESSING STYLES ===== */
.batch-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.batch-header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #475569;
}

.batch-header h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.batch-subtitle {
    color: #94a3b8;
    font-size: 1.125rem;
    max-width: 600px;
    margin: 0 auto;
}

/* Upload Methods */
.upload-methods {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.method-card {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.method-card:hover {
    border-color: #6366f1;
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(99, 102, 241, 0.1);
}

.method-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.method-card h4 {
    font-size: 1.125rem;
    color: #f8fafc;
    margin: 0;
}

.method-card p {
    color: #94a3b8;
    font-size: 0.875rem;
    margin: 0;
}

/* Dropzone */
.batch-dropzone {
    margin-bottom: 2rem;
    animation: fadeIn 0.3s ease;
}

.dropzone-area {
    border: 3px dashed #475569;
    border-radius: 16px;
    padding: 4rem 2rem;
    text-align: center;
    transition: all 0.3s;
    background: rgba(30, 41, 59, 0.5);
    cursor: pointer;
}

.dropzone-area:hover {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.05);
}

.dropzone-area.highlight {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.1);
    transform: scale(1.02);
}

.dropzone-area i {
    font-size: 4rem;
    color: #6366f1;
    margin-bottom: 1rem;
}

.dropzone-area h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: #f8fafc;
}

.dropzone-area p {
    color: #94a3b8;
    margin-bottom: 1rem;
}

.file-hint {
    font-size: 0.875rem;
    color: #64748b;
    margin-top: 1rem;
}

/* File List */
.file-list-section {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 2rem;
    animation: fadeIn 0.3s ease;
}

.file-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #475569;
    background: rgba(30, 41, 59, 0.8);
}

.file-list-header h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
    color: #f8fafc;
}

.file-list-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

#file-count {
    color: #94a3b8;
    font-weight: 500;
}

.file-list-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 1.5rem;
}

.file-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(71, 85, 105, 0.3);
    transition: background 0.3s;
}

.file-item:hover {
    background: rgba(51, 65, 85, 0.3);
}

.file-item:last-child {
    border-bottom: none;
}

.file-icon {
    width: 40px;
    height: 40px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: #6366f1;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 500;
    color: #f8fafc;
    margin-bottom: 0.25rem;
    word-break: break-all;
}

.file-details {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
}

.file-size {
    color: #94a3b8;
}

.file-type {
    color: #64748b;
    background: rgba(100, 116, 139, 0.2);
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
}

.file-remove {
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    transition: all 0.3s;
}

.file-remove:hover {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.file-list-stats {
    display: flex;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-top: 1px solid #475569;
    background: rgba(30, 41, 59, 0.5);
}

.stat {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #94a3b8;
}

.stat-value {
    font-weight: 600;
    color: #f8fafc;
}

/* Options Tabs */
.batch-options {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 2rem;
}

.batch-options h3 {
    padding: 1.5rem;
    margin: 0;
    border-bottom: 1px solid #475569;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #f8fafc;
}

.options-tabs {
    display: flex;
    border-bottom: 1px solid #475569;
    overflow-x: auto;
}

.tab-btn {
    background: none;
    border: none;
    padding: 1rem 1.5rem;
    color: #94a3b8;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    border-bottom: 2px solid transparent;
}

.tab-btn:hover {
    color: #f8fafc;
    background: rgba(51, 65, 85, 0.3);
}

.tab-btn.active {
    color: #6366f1;
    border-bottom-color: #6366f1;
    background: rgba(99, 102, 241, 0.05);
}

.options-content {
    display: none;
    padding: 2rem;
    animation: fadeIn 0.3s ease;
}

.options-content.active {
    display: block;
}

.option-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.option {
    margin-bottom: 1.5rem;
}

.option:last-child {
    margin-bottom: 0;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #f8fafc;
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    background: #334155;
    border: 1px solid #475569;
    border-radius: 8px;
    color: #f8fafc;
    font-family: inherit;
    font-size: 0.95rem;
    transition: all 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

.slider {
    width: 100%;
    height: 6px;
    background: #334155;
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #6366f1;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #1e293b;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #6366f1;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #1e293b;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.slider-value {
    margin-top: 0.5rem;
    font-weight: 500;
    color: #f8fafc;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
    margin-bottom: 0.5rem;
}

.checkbox-label input[type="checkbox"] {
    margin-top: 0.25rem;
    accent-color: #6366f1;
    cursor: pointer;
    width: 18px;
    height: 18px;
}

.checkbox-label span {
    flex: 1;
    color: #f8fafc;
    font-weight: 500;
}

.checkbox-label small {
    display: block;
    color: #94a3b8;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    margin-left: 1.75rem;
}

.engine-selection {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

/* Action Buttons */
.batch-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 3rem 0;
    padding: 2rem;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 12px;
}

.batch-actions .btn-lg {
    padding: 1rem 3rem;
    font-size: 1.1rem;
    min-width: 200px;
}

/* Processing Status */
.processing-status {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    animation: fadeIn 0.3s ease;
}

.processing-status h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    color: #f8fafc;
}

.job-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    margin-bottom: 2rem;
}

.job-id, .job-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-label {
    color: #94a3b8;
    font-weight: 500;
}

.info-value {
    color: #f8fafc;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-badge.pending {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.status-badge.processing {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.status-badge.completed {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-badge.failed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

/* Progress Section */
.progress-section {
    margin-bottom: 2rem;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.progress-header span:first-child {
    color: #f8fafc;
    font-weight: 500;
}

.progress-header span:last-child {
    color: #94a3b8;
    font-weight: 600;
}

.progress-bar-large {
    height: 12px;
    background: #334155;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-fill-large {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 6px;
    width: 0%;
    transition: width 0.5s ease;
}

.progress-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
}

.progress-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.progress-label {
    color: #94a3b8;
}

.progress-value {
    color: #f8fafc;
    font-weight: 600;
}

/* File Progress */
.file-progress-section h4 {
    color: #f8fafc;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-progress-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 0.5rem;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
}

.file-progress-item {
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 6px;
    border: 1px solid rgba(71, 85, 105, 0.3);
}

.file-progress-item:last-child {
    margin-bottom: 0;
}

.file-progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.file-name {
    color: #f8fafc;
    font-size: 0.875rem;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}

.file-status {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    margin-left: 1rem;
    min-width: 70px;
    text-align: center;
}

.file-status.pending {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.file-status.processing {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.file-status.completed {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.file-status.failed {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.file-progress-bar {
    height: 4px;
    background: #334155;
    border-radius: 2px;
    overflow: hidden;
}

.file-progress-fill {
    height: 100%;
    background: #3b82f6;
    border-radius: 2px;
    width: 0%;
    transition: width 0.5s ease;
}

/* Control Buttons */
.control-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #475569;
}

/* Results Section */
.batch-results {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
    animation: fadeIn 0.3s ease;
}

.batch-results h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
    color: #f8fafc;
}

/* Summary Cards */
.results-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.summary-card {
    background: rgba(51, 65, 85, 0.5);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: transform 0.3s;
}

.summary-card:hover {
    transform: translateY(-2px);
}

.summary-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.summary-icon.success {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.summary-icon.warning {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.summary-icon.info {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.summary-icon.primary {
    background: rgba(99, 102, 241, 0.2);
    color: #6366f1;
}

.summary-content {
    flex: 1;
}

.summary-value {
    font-size: 2rem;
    font-weight: 700;
    color: #f8fafc;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.summary-label {
    font-size: 0.875rem;
    color: #94a3b8;
}

/* Results Table */
.results-table-section {
    margin-bottom: 2rem;
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.table-header h4 {
    color: #f8fafc;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table-actions {
    display: flex;
    gap: 0.5rem;
}

.table-responsive {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #475569;
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.results-table thead {
    background: rgba(51, 65, 85, 0.8);
}

.results-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #f8fafc;
    border-bottom: 1px solid #475569;
}

.results-table tbody tr {
    transition: background 0.3s;
    border-bottom: 1px solid rgba(71, 85, 105, 0.3);
}

.results-table tbody tr:hover {
    background: rgba(51, 65, 85, 0.3);
}

.results-table tbody tr:last-child {
    border-bottom: none;
}

.results-table td {
    padding: 1rem;
    color: #94a3b8;
}

.results-table td:first-child {
    color: #f8fafc;
    font-weight: 500;
}

.results-table .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Failed Files */
.failed-files {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.failed-files h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ef4444;
    margin-bottom: 1rem;
}

.failed-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.failed-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: rgba(239, 68, 68, 0.05);
    border-radius: 6px;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.failed-file {
    color: #f8fafc;
    font-weight: 500;
    flex: 1;
}

.failed-error {
    color: #fca5a5;
    font-size: 0.875rem;
    flex: 2;
    padding: 0 1rem;
}

/* Final Actions */
.final-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    padding-top: 2rem;
    border-top: 1px solid #475569;
}

/* Modals */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 1rem;
}

.modal-content {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.3s ease;
}

.modal-lg {
    max-width: 800px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #475569;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #f8fafc;
}

.modal-close {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
    transition: color 0.3s;
}

.modal-close:hover {
    color: #f8fafc;
}

.modal-body {
    padding: 1.5rem;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .batch-container {
        padding: 1rem;
    }
    
    .batch-header h1 {
        font-size: 2rem;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .upload-methods {
        grid-template-columns: 1fr;
    }
    
    .options-tabs {
        flex-wrap: wrap;
    }
    
    .tab-btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
    
    .batch-actions {
        flex-direction: column;
    }
    
    .batch-actions .btn {
        width: 100%;
    }
    
    .job-info {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .progress-details {
        grid-template-columns: 1fr;
    }
    
    .results-summary {
        grid-template-columns: 1fr 1fr;
    }
    
    .failed-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .failed-error {
        padding: 0;
    }
    
    .final-actions {
        flex-direction: column;
    }
    
    .final-actions .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .batch-header h1 {
        font-size: 1.75rem;
    }
    
    .dropzone-area {
        padding: 2rem 1rem;
    }
    
    .results-summary {
        grid-template-columns: 1fr;
    }
    
    .control-buttons {
        flex-direction: column;
    }
    
    .control-buttons .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="batch-container">
    <div class="batch-header">
        <h1><i class="fas fa-layer-group"></i> Batch Processing</h1>
        <p class="batch-subtitle">Upload and process multiple images simultaneously with progress tracking and parallel execution</p>
    </div>

    <!-- Upload Section -->
    <div class="batch-upload-section">
        <div class="upload-methods">
            <div class="method-card" onclick="showDropzone()">
                <div class="method-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h4>Drag & Drop</h4>
                <p>Drag multiple image files here</p>
            </div>
            
            <div class="method-card" onclick="document.getElementById('file-input-multiple').click()">
                <div class="method-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h4>Browse Files</h4>
                <p>Select multiple images from your computer</p>
            </div>
            
            <div class="method-card" onclick="showFolderUpload()">
                <div class="method-icon">
                    <i class="fas fa-folder"></i>
                </div>
                <h4>Upload Folder</h4>
                <p>Upload entire folder of images</p>
            </div>
        </div>

        <!-- Dropzone -->
        <div class="batch-dropzone" id="batch-dropzone" style="display: none;">
            <div class="dropzone-area" id="dropzone-area">
                <i class="fas fa-file-upload"></i>
                <h3>Drop Images Here</h3>
                <p>or click to select files</p>
                <p class="file-hint">Supports JPG, PNG, BMP, TIFF, WEBP (max 50MB each)</p>
            </div>
            
            <input type="file" id="file-input-multiple" multiple 
                   accept=".jpg,.jpeg,.png,.bmp,.tiff,.webp" style="display: none;">
        </div>

        <!-- File List -->
        <div class="file-list-section" id="file-list-section" style="display: none;">
            <div class="file-list-header">
                <h4><i class="fas fa-list"></i> Selected Files</h4>
                <div class="file-list-actions">
                    <span id="file-count">0 files</span>
                    <button class="btn btn-sm btn-secondary" onclick="clearFileList()">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                </div>
            </div>
            
            <div class="file-list-container" id="file-list-container">
                <!-- Files will be listed here -->
            </div>
            
            <div class="file-list-stats">
                <div class="stat">
                    <span class="stat-label">Total Size:</span>
                    <span class="stat-value" id="total-size">0 MB</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Estimated Time:</span>
                    <span class="stat-value" id="estimated-time">0s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Options -->
    <div class="batch-options">
        <h3><i class="fas fa-sliders-h"></i> Processing Options</h3>
        
        <div class="options-tabs">
            <button class="tab-btn active" onclick="switchOptionsTab('general')">
                <i class="fas fa-cog"></i> General
            </button>
            <button class="tab-btn" onclick="switchOptionsTab('detection')">
                <i class="fas fa-search"></i> Detection
            </button>
            <button class="tab-btn" onclick="switchOptionsTab('ocr')">
                <i class="fas fa-font"></i> OCR
            </button>
            <button class="tab-btn" onclick="switchOptionsTab('output')">
                <i class="fas fa-download"></i> Output
            </button>
        </div>
        
        <!-- General Options -->
        <div id="general-options" class="options-content active">
            <div class="option-group">
                <div class="option">
                    <label class="form-label">Processing Mode</label>
                    <select class="form-control" id="processing-mode">
                        <option value="sequential">Sequential (One by one)</option>
                        <option value="parallel" selected>Parallel (Multi-threaded)</option>
                    </select>
                </div>
                
                <div class="option">
                    <label class="form-label">Max Parallel Jobs</label>
                    <input type="range" id="max-workers" min="1" max="8" value="4" class="slider">
                    <div class="slider-value">
                        <span id="workers-value">4</span> workers
                    </div>
                    <small>Higher values use more CPU but process faster</small>
                </div>
                
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="stop-on-error" checked>
                        <span>Stop on Error</span>
                    </label>
                    <small>Stop processing if any file fails</small>
                </div>
            </div>
        </div>
        
        <!-- Detection Options -->
        <div id="detection-options" class="options-content">
            <div class="option-group">
                <div class="option">
                    <label class="form-label">Detection Method</label>
                    <select class="form-control" id="detection-method">
                        <option value="auto" selected>Auto (YOLO + Fallback)</option>
                        <option value="yolo_only">YOLO Only</option>
                        <option value="fallback_only">CV Fallback Only</option>
                    </select>
                </div>
                
                <div class="option">
                    <label class="form-label">Confidence Threshold</label>
                    <input type="range" id="confidence-threshold" min="10" max="90" value="25" class="slider">
                    <div class="slider-value">
                        <span id="confidence-value">0.25</span>
                    </div>
                    <small>Higher values = fewer but more confident detections</small>
                </div>
                
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enable-multiscale" checked>
                        <span>Multi-scale Detection</span>
                    </label>
                    <small>Detect plates at different scales</small>
                </div>
            </div>
        </div>
        
        <!-- OCR Options -->
        <div id="ocr-options" class="options-content">
            <div class="option-group">
                <div class="option">
                    <label class="form-label">OCR Engines</label>
                    <div class="engine-selection">
                        <label class="checkbox-label">
                            <input type="checkbox" id="batch-ocr-easyocr" checked>
                            <span>EasyOCR</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="batch-ocr-tesseract" checked>
                            <span>Tesseract</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="batch-ocr-google">
                            <span>Google Vision</span>
                        </label>
                    </div>
                </div>
                
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="batch-preprocess" checked>
                        <span>Image Preprocessing</span>
                    </label>
                    <small>Enhance images before OCR</small>
                </div>
                
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="compare-engines">
                        <span>Compare All Engines</span>
                    </label>
                    <small>Run all selected engines and compare results</small>
                </div>
            </div>
        </div>
        
        <!-- Output Options -->
        <div id="output-options" class="options-content">
            <div class="option-group">
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="save-all-output" checked>
                        <span>Save Output Files</span>
                    </label>
                    <small>Save cropped plates and visualizations</small>
                </div>
                
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="save-to-db" checked>
                        <span>Save to Database</span>
                    </label>
                    <small>Store all results in database</small>
                </div>
                
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="generate-report">
                        <span>Generate Report</span>
                    </label>
                    <small>Create PDF report with all results</small>
                </div>
                
                <div class="option">
                    <label class="form-label">Export Format</label>
                    <select class="form-control" id="export-format">
                        <option value="json" selected>JSON</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="batch-actions">
        <button class="btn btn-primary btn-lg" id="start-batch-btn" onclick="startBatchProcessing()" disabled>
            <i class="fas fa-play-circle"></i> Start Batch Processing
        </button>
        <button class="btn btn-secondary btn-lg" onclick="resetBatch()">
            <i class="fas fa-redo"></i> Reset
        </button>
    </div>

    <!-- Processing Status -->
    <div class="processing-status" id="processing-status" style="display: none;">
        <h3><i class="fas fa-tasks"></i> Processing Status</h3>
        
        <!-- Job Info -->
        <div class="job-info">
            <div class="job-id">
                <span class="info-label">Job ID:</span>
                <span class="info-value" id="job-id">--</span>
            </div>
            <div class="job-status">
                <span class="info-label">Status:</span>
                <span class="status-badge pending" id="job-status">Pending</span>
            </div>
        </div>
        
        <!-- Progress -->
        <div class="progress-section">
            <div class="progress-header">
                <span>Overall Progress</span>
                <span id="overall-progress-text">0%</span>
            </div>
            <div class="progress-bar-large">
                <div class="progress-fill-large" id="overall-progress-bar" style="width: 0%"></div>
            </div>
            
            <div class="progress-details">
                <div class="progress-item">
                    <span class="progress-label">Processed:</span>
                    <span class="progress-value">
                        <span id="processed-count">0</span> / 
                        <span id="total-count">0</span> files
                    </span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Successful:</span>
                    <span class="progress-value" id="successful-count">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Failed:</span>
                    <span class="progress-value" id="failed-count">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Elapsed Time:</span>
                    <span class="progress-value" id="elapsed-time">00:00</span>
                </div>
            </div>
        </div>
        
        <!-- File Progress -->
        <div class="file-progress-section">
            <h4><i class="fas fa-file-image"></i> File Progress</h4>
            <div class="file-progress-list" id="file-progress-list">
                <!-- Individual file progress will be shown here -->
            </div>
        </div>
        
        <!-- Control Buttons -->
        <div class="control-buttons">
            <button class="btn btn-secondary" id="pause-btn" onclick="pauseProcessing()">
                <i class="fas fa-pause"></i> Pause
            </button>
            <button class="btn btn-danger" id="cancel-btn" onclick="cancelProcessing()">
                <i class="fas fa-stop"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div class="batch-results" id="batch-results" style="display: none;">
        <h3><i class="fas fa-chart-bar"></i> Batch Results</h3>
        
        <!-- Summary Stats -->
        <div class="results-summary">
            <div class="summary-card">
                <div class="summary-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="results-successful">0</div>
                    <div class="summary-label">Successful</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon warning">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="results-failed">0</div>
                    <div class="summary-label">Failed</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon info">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="results-time">0s</div>
                    <div class="summary-label">Total Time</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon primary">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-value" id="results-accuracy">0%</div>
                    <div class="summary-label">Avg Confidence</div>
                </div>
            </div>
        </div>
        
        <!-- Results Table -->
        <div class="results-table-section">
            <div class="table-header">
                <h4><i class="fas fa-table"></i> Detailed Results</h4>
                <div class="table-actions">
                    <button class="btn btn-sm btn-secondary" onclick="exportResults()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="saveAllResults()">
                        <i class="fas fa-save"></i> Save All
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Status</th>
                            <th>Detected</th>
                            <th>OCR Text</th>
                            <th>Confidence</th>
                            <th>Engine</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Failed Files -->
        <div class="failed-files" id="failed-files-section" style="display: none;">
            <h4><i class="fas fa-exclamation-triangle"></i> Failed Files</h4>
            <div class="failed-list" id="failed-files-list">
                <!-- Failed files will be listed here -->
            </div>
        </div>
        
        <!-- Final Actions -->
        <div class="final-actions">
            <button class="btn btn-primary" onclick="processNewBatch()">
                <i class="fas fa-redo"></i> Process New Batch
            </button>
            <button class="btn btn-secondary" onclick="viewInDashboard()">
                <i class="fas fa-chart-bar"></i> View in Dashboard
            </button>
            <button class="btn btn-outline" onclick="downloadReport()">
                <i class="fas fa-file-pdf"></i> Download Report
            </button>
        </div>
    </div>
</div>

<!-- Job Status Modal -->
<div class="modal" id="job-modal" style="display: none;">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3><i class="fas fa-tasks"></i> Batch Job Details</h3>
            <button class="modal-close" onclick="closeJobModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="job-details-content">
                <!-- Job details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Error Details Modal -->
<div class="modal" id="error-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-circle"></i> Error Details</h3>
            <button class="modal-close" onclick="closeErrorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="error-details-content">
                <!-- Error details will be shown here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== BATCH PROCESSING SCRIPT =====
let selectedFiles = [];
let batchJobId = null;
let statusPollingInterval = null;
let isProcessingPaused = false;
let batchStartTime = null;
let batchResults = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Setup event listeners
    document.getElementById('file-input-multiple').addEventListener('change', handleFileSelect);
    
    // Initialize sliders
    const confidenceSlider = document.getElementById('confidence-threshold');
    const workersSlider = document.getElementById('max-workers');
    
    if (confidenceSlider) {
        confidenceSlider.addEventListener('input', function() {
            const value = this.value / 100;
            document.getElementById('confidence-value').textContent = value.toFixed(2);
        });
    }
    
    if (workersSlider) {
        workersSlider.addEventListener('input', function() {
            document.getElementById('workers-value').textContent = this.value;
        });
    }
    
    // Initialize dropzone
    initDropzone();
    
    // Update initial slider values
    if (confidenceSlider) {
        confidenceSlider.dispatchEvent(new Event('input'));
    }
    if (workersSlider) {
        workersSlider.dispatchEvent(new Event('input'));
    }
});

function showDropzone() {
    document.getElementById('batch-dropzone').style.display = 'block';
}

function showFolderUpload() {
    // Note: Folder upload requires webkitdirectory attribute
    try {
        const input = document.createElement('input');
        input.type = 'file';
        input.webkitdirectory = true;
        input.multiple = true;
        input.accept = '.jpg,.jpeg,.png,.bmp,.tiff,.webp';
        input.style.display = 'none';
        
        input.addEventListener('change', function(e) {
            handleFolderSelect(e);
        });
        
        document.body.appendChild(input);
        input.click();
        setTimeout(() => document.body.removeChild(input), 1000);
    } catch (error) {
        showNotification('Folder upload not supported in this browser', 'warning');
        document.getElementById('file-input-multiple').click();
    }
}

function initDropzone() {
    const dropzoneArea = document.getElementById('dropzone-area');
    
    if (!dropzoneArea) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzoneArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzoneArea.addEventListener(eventName, highlightDropzone, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropzoneArea.addEventListener(eventName, unhighlightDropzone, false);
    });
    
    dropzoneArea.addEventListener('drop', handleDrop, false);
    dropzoneArea.addEventListener('click', () => {
        document.getElementById('file-input-multiple').click();
    });
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlightDropzone() {
    const dropzoneArea = document.getElementById('dropzone-area');
    if (dropzoneArea) {
        dropzoneArea.classList.add('highlight');
    }
}

function unhighlightDropzone() {
    const dropzoneArea = document.getElementById('dropzone-area');
    if (dropzoneArea) {
        dropzoneArea.classList.remove('highlight');
    }
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
}

function handleFolderSelect(e) {
    const files = Array.from(e.target.files);
    handleFiles(files);
}

function handleFiles(fileList) {
    if (!fileList || fileList.length === 0) return;
    
    const files = Array.from(fileList);
    const validFiles = files.filter(file => {
        // Check file type
        if (!file.type.match('image.*')) {
            showNotification(`Skipped ${file.name}: Not an image file`, 'warning');
            return false;
        }
        
        // Check file size (max 50MB)
        if (file.size > 50 * 1024 * 1024) {
            showNotification(`Skipped ${file.name}: File too large (max 50MB)`, 'warning');
            return false;
        }
        
        // Check if file already exists
        const exists = selectedFiles.some(f => 
            f.name === file.name && 
            f.size === file.size && 
            f.lastModified === file.lastModified
        );
        
        if (exists) {
            showNotification(`Skipped ${file.name}: Already added`, 'info');
            return false;
        }
        
        return true;
    });
    
    if (validFiles.length === 0) return;
    
    // Add valid files to selection
    selectedFiles.push(...validFiles);
    
    updateFileList();
    updateStartButton();
    
    showNotification(`Added ${validFiles.length} file${validFiles.length === 1 ? '' : 's'}`, 'success');
}

function updateFileList() {
    const container = document.getElementById('file-list-container');
    const fileCountElement = document.getElementById('file-count');
    const fileListSection = document.getElementById('file-list-section');
    
    if (!container || !fileCountElement || !fileListSection) return;
    
    if (selectedFiles.length === 0) {
        fileListSection.style.display = 'none';
        return;
    }
    
    // Show file list section
    fileListSection.style.display = 'block';
    
    // Update file count
    fileCountElement.textContent = `${selectedFiles.length} file${selectedFiles.length !== 1 ? 's' : ''}`;
    
    // Calculate total size
    const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
    document.getElementById('total-size').textContent = formatFileSize(totalSize);
    
    // Estimate processing time (2 seconds per file, divided by workers)
    const workers = parseInt(document.getElementById('max-workers')?.value || 4);
    const estimatedTime = Math.ceil(selectedFiles.length * 2 / workers);
    document.getElementById('estimated-time').textContent = `${estimatedTime}s`;
    
    // Render file list
    container.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-icon">
                <i class="fas fa-image"></i>
            </div>
            <div class="file-info">
                <div class="file-name">${escapeHtml(file.name)}</div>
                <div class="file-details">
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <span class="file-type">${getFileExtension(file.name).toUpperCase()}</span>
                </div>
            </div>
            <button class="file-remove" onclick="removeFile(${index})" title="Remove file">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(fileItem);
    });
    
    // Scroll to file list
    fileListSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function removeFile(index) {
    if (index >= 0 && index < selectedFiles.length) {
        const fileName = selectedFiles[index].name;
        selectedFiles.splice(index, 1);
        updateFileList();
        updateStartButton();
        showNotification(`Removed ${fileName}`, 'info');
    }
}

function clearFileList() {
    if (selectedFiles.length === 0) return;
    
    const fileCount = selectedFiles.length;
    selectedFiles = [];
    updateFileList();
    updateStartButton();
    showNotification(`Cleared ${fileCount} file${fileCount === 1 ? '' : 's'}`, 'info');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileExtension(filename) {
    return filename.split('.').pop() || '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateStartButton() {
    const startBtn = document.getElementById('start-batch-btn');
    if (startBtn) {
        startBtn.disabled = selectedFiles.length === 0;
    }
}

function switchOptionsTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.options-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    const targetTab = document.getElementById(`${tabName}-options`);
    const targetBtn = document.querySelector(`.tab-btn[onclick*="${tabName}"]`);
    
    if (targetTab) targetTab.classList.add('active');
    if (targetBtn) targetBtn.classList.add('active');
}

async function startBatchProcessing() {
    if (selectedFiles.length === 0) {
        showNotification('Please select files to process', 'error');
        return;
    }
    
    try {
        // Disable start button
        document.getElementById('start-batch-btn').disabled = true;
        
        // Prepare form data
        const formData = new FormData();
        
        // Add files
        selectedFiles.forEach((file, index) => {
            formData.append(`image_${index}`, file);
        });
        
        // Add file metadata
        const fileMetadata = selectedFiles.map(file => ({
            name: file.name,
            size: file.size,
            type: file.type
        }));
        formData.append('file_metadata', JSON.stringify(fileMetadata));
        
        // Prepare processing options
        const options = {
            detection: {
                use_yolo: document.getElementById('detection-method').value !== 'fallback_only',
                use_fallback: document.getElementById('detection-method').value !== 'yolo_only',
                multi_scale: document.getElementById('enable-multiscale').checked,
                confidence_threshold: parseFloat(document.getElementById('confidence-value').textContent)
            },
            ocr: {
                engines: {
                    easyocr: document.getElementById('batch-ocr-easyocr').checked,
                    tesseract: document.getElementById('batch-ocr-tesseract').checked,
                    google_vision: document.getElementById('batch-ocr-google').checked
                },
                preprocess: document.getElementById('batch-preprocess').checked,
                compare_engines: document.getElementById('compare-engines').checked
            },
            output: {
                save_files: document.getElementById('save-all-output').checked,
                save_to_db: document.getElementById('save-to-db').checked,
                generate_report: document.getElementById('generate-report').checked,
                format: document.getElementById('export-format').value
            },
            performance: {
                max_workers: parseInt(document.getElementById('max-workers').value),
                batch_size: 4,
                stop_on_error: document.getElementById('stop-on-error').checked
            }
        };
        
        formData.append('options', JSON.stringify(options));
        
        // Show processing status
        document.getElementById('processing-status').style.display = 'block';
        document.getElementById('batch-results').style.display = 'none';
        
        // Initialize progress display
        initializeProgress();
        
        // Start timer
        batchStartTime = new Date();
        updateElapsedTime();
        
        // Start batch processing
        const response = await fetch('/api/process/batch', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        batchJobId = data.job_id;
        document.getElementById('job-id').textContent = batchJobId;
        document.getElementById('job-status').textContent = 'Processing';
        document.getElementById('job-status').className = 'status-badge processing';
        
        // Start polling for status updates
        startStatusPolling();
        
        showNotification(`Batch processing started (Job: ${batchJobId})`, 'success');
        
    } catch (error) {
        console.error('Failed to start batch processing:', error);
        showNotification('Failed to start batch processing: ' + error.message, 'error');
        
        // Re-enable start button
        document.getElementById('start-batch-btn').disabled = false;
        
        // Hide processing status
        document.getElementById('processing-status').style.display = 'none';
    }
}

function initializeProgress() {
    const totalCount = selectedFiles.length;
    document.getElementById('total-count').textContent = totalCount;
    document.getElementById('processed-count').textContent = '0';
    document.getElementById('successful-count').textContent = '0';
    document.getElementById('failed-count').textContent = '0';
    document.getElementById('overall-progress-bar').style.width = '0%';
    document.getElementById('overall-progress-text').textContent = '0%';
    
    // Initialize file progress list
    const fileList = document.getElementById('file-progress-list');
    fileList.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const progressItem = document.createElement('div');
        progressItem.className = 'file-progress-item';
        progressItem.id = `file-progress-${index}`;
        progressItem.innerHTML = `
            <div class="file-progress-info">
                <div class="file-name">${escapeHtml(file.name)}</div>
                <div class="file-status pending">Pending</div>
            </div>
            <div class="file-progress-bar">
                <div class="file-progress-fill" style="width: 0%"></div>
            </div>
        `;
        fileList.appendChild(progressItem);
    });
}

function startStatusPolling() {
    // Clear existing interval
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
    }
    
    // Start new polling interval
    statusPollingInterval = setInterval(async () => {
        if (isProcessingPaused || !batchJobId) return;
        
        try {
            const response = await fetch(`/api/process/batch/${batchJobId}/status`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            updateProcessingStatus(data);
            
            // Check if processing is complete
            if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
                
                if (data.status === 'completed') {
                    showNotification('Batch processing completed successfully!', 'success');
                    setTimeout(() => showBatchResults(data), 500);
                } else if (data.status === 'failed') {
                    showNotification('Batch processing failed', 'error');
                } else if (data.status === 'cancelled') {
                    showNotification('Batch processing cancelled', 'info');
                }
                
                // Re-enable start button
                document.getElementById('start-batch-btn').disabled = false;
            }
            
        } catch (error) {
            console.error('Error polling status:', error);
        }
    }, 2000); // Poll every 2 seconds
}

function updateProcessingStatus(data) {
    if (!data) return;
    
    // Update job status
    const statusBadge = document.getElementById('job-status');
    if (statusBadge) {
        statusBadge.textContent = data.status;
        statusBadge.className = `status-badge ${data.status}`;
    }
    
    // Update progress
    const progress = data.progress || 0;
    document.getElementById('overall-progress-bar').style.width = progress + '%';
    document.getElementById('overall-progress-text').textContent = Math.round(progress) + '%';
    
    // Update counts
    if (data.processed_files !== undefined) {
        document.getElementById('processed-count').textContent = data.processed_files;
    }
    if (data.successful_files !== undefined) {
        document.getElementById('successful-count').textContent = data.successful_files;
    }
    if (data.failed_files !== undefined) {
        document.getElementById('failed-count').textContent = data.failed_files;
    }
    
    // Update individual file progress if available
    if (data.file_progress && Array.isArray(data.file_progress)) {
        updateFileProgress(data.file_progress);
    }
}

function updateFileProgress(fileProgress) {
    fileProgress.forEach((progress, index) => {
        const item = document.getElementById(`file-progress-${index}`);
        if (!item) return;
        
        const statusElement = item.querySelector('.file-status');
        const progressBar = item.querySelector('.file-progress-fill');
        
        if (statusElement) {
            statusElement.textContent = progress.status || 'Processing';
            statusElement.className = `file-status ${progress.status}`;
        }
        
        if (progressBar && progress.progress !== undefined) {
            progressBar.style.width = progress.progress + '%';
            progressBar.style.transition = 'width 0.5s ease';
            
            // Update color based on status
            if (progress.status === 'completed') {
                progressBar.style.backgroundColor = '#10b981';
            } else if (progress.status === 'failed') {
                progressBar.style.backgroundColor = '#ef4444';
            } else {
                progressBar.style.backgroundColor = '#3b82f6';
            }
        }
    });
}

function updateElapsedTime() {
    if (!batchStartTime) return;
    
    const now = new Date();
    const diff = Math.floor((now - batchStartTime) / 1000);
    const minutes = Math.floor(diff / 60);
    const seconds = diff % 60;
    
    const timeElement = document.getElementById('elapsed-time');
    if (timeElement) {
        timeElement.textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Continue updating every second
    if (statusPollingInterval) {
        setTimeout(updateElapsedTime, 1000);
    }
}

function pauseProcessing() {
    if (!batchJobId) return;
    
    isProcessingPaused = !isProcessingPaused;
    const btn = document.getElementById('pause-btn');
    
    if (isProcessingPaused) {
        btn.innerHTML = '<i class="fas fa-play"></i> Resume';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-success');
        showNotification('Processing paused', 'info');
    } else {
        btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-secondary');
        showNotification('Processing resumed', 'info');
    }
}

async function cancelProcessing() {
    if (!batchJobId || !confirm('Are you sure you want to cancel batch processing?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/process/batch/${batchJobId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
            
            showNotification('Processing cancelled', 'info');
            
            // Hide processing status
            document.getElementById('processing-status').style.display = 'none';
            
            // Re-enable start button
            document.getElementById('start-batch-btn').disabled = false;
        } else {
            showNotification('Failed to cancel processing: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showNotification('Failed to cancel processing: ' + error.message, 'error');
    }
}

function showBatchResults(data) {
    // Hide processing status
    document.getElementById('processing-status').style.display = 'none';
    
    // Show results section
    const resultsSection = document.getElementById('batch-results');
    if (resultsSection) {
        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Store results
    batchResults = data.results || [];
    
    // Update summary statistics
    if (data.results && data.results.length > 0) {
        const successful = data.results.filter(r => r.success).length;
        const failed = data.results.length - successful;
        const avgConfidence = data.results
            .filter(r => r.success && r.best_ocr)
            .reduce((sum, r) => sum + (r.best_ocr.confidence || 0), 0) / 
            Math.max(successful, 1);
        
        document.getElementById('results-successful').textContent = successful;
        document.getElementById('results-failed').textContent = failed;
        document.getElementById('results-time').textContent = data.elapsed_time?.toFixed(2) + 's' || 'N/A';
        document.getElementById('results-accuracy').textContent = (avgConfidence * 100).toFixed(1) + '%';
        
        // Populate results table
        const tableBody = document.getElementById('results-table-body');
        if (tableBody) {
            tableBody.innerHTML = '';
            
            data.results.forEach((result, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${result.filename || 'Unknown'}</td>
                    <td>
                        <span class="status-badge ${result.success ? 'success' : 'error'}">
                            ${result.success ? 'Success' : 'Failed'}
                        </span>
                    </td>
                    <td>${result.detections?.length || 0}</td>
                    <td>${result.best_ocr?.text || 'N/A'}</td>
                    <td>${result.best_ocr ? (result.best_ocr.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td>${result.best_ocr?.engine || 'N/A'}</td>
                    <td>${result.processing_time?.toFixed(2) || '0.00'}s</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewResultDetails(${index})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${result.success ? `
                        <button class="btn btn-sm btn-outline" onclick="saveSingleResult(${index})" title="Save Result">
                            <i class="fas fa-save"></i>
                        </button>
                        ` : `
                        <button class="btn btn-sm btn-outline" onclick="showErrorDetails(${index})" title="View Error">
                            <i class="fas fa-exclamation-circle"></i>
                        </button>
                        `}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Show failed files if any
        if (failed > 0) {
            const failedSection = document.getElementById('failed-files-section');
            const failedList = document.getElementById('failed-files-list');
            
            if (failedSection) failedSection.style.display = 'block';
            if (failedList) {
                failedList.innerHTML = '';
                
                data.results.filter(r => !r.success).forEach((result, index) => {
                    const failedItem = document.createElement('div');
                    failedItem.className = 'failed-item';
                    failedItem.innerHTML = `
                        <div class="failed-file">${result.filename || 'Unknown'}</div>
                        <div class="failed-error">${result.error || 'Unknown error'}</div>
                        <button class="btn btn-sm btn-secondary" onclick="retryFile(${index})">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    `;
                    failedList.appendChild(failedItem);
                });
            }
        }
    } else {
        // No results or empty results
        document.getElementById('results-successful').textContent = '0';
        document.getElementById('results-failed').textContent = '0';
        document.getElementById('results-time').textContent = '0s';
        document.getElementById('results-accuracy').textContent = '0%';
        
        // Show error message
        const tableBody = document.getElementById('results-table-body');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-exclamation-triangle"></i> No results available
                    </td>
                </tr>
            `;
        }
    }
}

function viewResultDetails(index) {
    if (index >= 0 && index < batchResults.length) {
        const result = batchResults[index];
        
        // Create modal content
        const modalContent = document.getElementById('job-details-content');
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="result-details">
                    <h4>Result Details</h4>
                    <div class="detail-section">
                        <h5>File Information</h5>
                        <p><strong>Filename:</strong> ${result.filename || 'N/A'}</p>
                        <p><strong>Status:</strong> ${result.success ? 'Success' : 'Failed'}</p>
                        <p><strong>Processing Time:</strong> ${result.processing_time?.toFixed(2) || '0.00'}s</p>
                    </div>
                    
                    ${result.success ? `
                    <div class="detail-section">
                        <h5>Detection Results</h5>
                        <p><strong>Plates Detected:</strong> ${result.detections?.length || 0}</p>
                        ${result.detections && result.detections.length > 0 ? `
                        <div class="detection-list">
                            <h6>Detections:</h6>
                            <ul>
                                ${result.detections.map((det, i) => `
                                    <li>#${i + 1}: ${det.method || 'Unknown'} - Confidence: ${(det.confidence * 100).toFixed(1)}%</li>
                                `).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="detail-section">
                        <h5>OCR Results</h5>
                        ${result.best_ocr ? `
                        <p><strong>Best Result:</strong> ${result.best_ocr.text}</p>
                        <p><strong>Engine:</strong> ${result.best_ocr.engine}</p>
                        <p><strong>Confidence:</strong> ${(result.best_ocr.confidence * 100).toFixed(1)}%</p>
                        ` : '<p>No OCR results available</p>'}
                    </div>
                    ` : `
                    <div class="detail-section error">
                        <h5>Error Information</h5>
                        <p><strong>Error:</strong> ${result.error || 'Unknown error'}</p>
                    </div>
                    `}
                </div>
            `;
            
            document.getElementById('job-modal').style.display = 'flex';
        }
    }
}

async function saveSingleResult(index) {
    if (index >= 0 && index < batchResults.length) {
        try {
            const result = batchResults[index];
            
            const response = await fetch('/api/results/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(result)
            });
            
            if (response.ok) {
                showNotification('Result saved to database', 'success');
            } else {
                throw new Error('Failed to save result');
            }
        } catch (error) {
            showNotification('Failed to save result: ' + error.message, 'error');
        }
    }
}

function showErrorDetails(index) {
    if (index >= 0 && index < batchResults.length) {
        const result = batchResults[index];
        const errorContent = document.getElementById('error-details-content');
        
        if (errorContent) {
            errorContent.innerHTML = `
                <h4>Error Details</h4>
                <div class="error-detail">
                    <p><strong>File:</strong> ${result.filename || 'Unknown'}</p>
                    <p><strong>Error:</strong> ${result.error || 'Unknown error'}</p>
                    <p><strong>Processing Time:</strong> ${result.processing_time?.toFixed(2) || '0.00'}s</p>
                </div>
            `;
            
            document.getElementById('error-modal').style.display = 'flex';
        }
    }
}

function retryFile(index) {
    showNotification('Retry functionality coming soon', 'info');
    // In a real implementation, this would re-process the specific file
}

function exportResults() {
    const format = document.getElementById('export-format').value;
    window.location.href = `/api/batch/export/${batchJobId}?format=${format}`;
}

async function saveAllResults() {
    try {
        const response = await fetch('/api/results/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                batch_id: batchJobId,
                results: batchResults 
            })
        });
        
        if (response.ok) {
            showNotification('All results saved to database', 'success');
        } else {
            throw new Error('Failed to save results');
        }
    } catch (error) {
        showNotification('Failed to save results: ' + error.message, 'error');
    }
}

function processNewBatch() {
    resetBatch();
}

function viewInDashboard() {
    window.location.href = '/dashboard';
}

function downloadReport() {
    window.location.href = `/api/batch/export/${batchJobId}?format=excel`;
}

function closeJobModal() {
    document.getElementById('job-modal').style.display = 'none';
}

function closeErrorModal() {
    document.getElementById('error-modal').style.display = 'none';
}

function resetBatch() {
    // Reset state
    selectedFiles = [];
    batchJobId = null;
    isProcessingPaused = false;
    batchStartTime = null;
    batchResults = [];
    
    // Clear polling interval
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
    }
    
    // Reset UI
    updateFileList();
    updateStartButton();
    document.getElementById('processing-status').style.display = 'none';
    document.getElementById('batch-results').style.display = 'none';
    
    // Reset options to defaults
    document.getElementById('processing-mode').value = 'parallel';
    document.getElementById('max-workers').value = 4;
    document.getElementById('stop-on-error').checked = true;
    document.getElementById('detection-method').value = 'auto';
    document.getElementById('confidence-threshold').value = 25;
    document.getElementById('enable-multiscale').checked = true;
    document.getElementById('batch-ocr-easyocr').checked = true;
    document.getElementById('batch-ocr-tesseract').checked = true;
    document.getElementById('batch-ocr-google').checked = false;
    document.getElementById('batch-preprocess').checked = true;
    document.getElementById('compare-engines').checked = false;
    document.getElementById('save-all-output').checked = true;
    document.getElementById('save-to-db').checked = true;
    document.getElementById('generate-report').checked = false;
    document.getElementById('export-format').value = 'json';
    
    // Trigger slider updates
    document.getElementById('confidence-threshold').dispatchEvent(new Event('input'));
    document.getElementById('max-workers').dispatchEvent(new Event('input'));
    
    switchOptionsTab('general');
    
    showNotification('Batch processing reset', 'info');
}

// Notification system
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        z-index: 10000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    `;
    
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle';
    notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
    
    document.body.appendChild(notification);
    
    // Add animation styles if not already present
    if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Make functions globally available
window.showDropzone = showDropzone;
window.showFolderUpload = showFolderUpload;
window.clearFileList = clearFileList;
window.switchOptionsTab = switchOptionsTab;
window.startBatchProcessing = startBatchProcessing;
window.pauseProcessing = pauseProcessing;
window.cancelProcessing = cancelProcessing;
window.viewResultDetails = viewResultDetails;
window.saveSingleResult = saveSingleResult;
window.showErrorDetails = showErrorDetails;
window.retryFile = retryFile;
window.exportResults = exportResults;
window.saveAllResults = saveAllResults;
window.processNewBatch = processNewBatch;
window.viewInDashboard = viewInDashboard;
window.downloadReport = downloadReport;
window.closeJobModal = closeJobModal;
window.closeErrorModal = closeErrorModal;
window.resetBatch = resetBatch;
</script>
{% endblock %}