{% extends "layout.html" %}

{% block title %}Dashboard - Plate Detection{% endblock %}

{% block extra_css %}
<style>
/* ===== DASHBOARD STYLES ===== */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #475569;
}

.dashboard-header h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 0;
}

.dashboard-actions {
    display: flex;
    gap: 1rem;
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.dashboard-card {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    border-color: #6366f1;
}

.dashboard-card h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 1.5rem 0;
    color: #f8fafc;
    font-size: 1.25rem;
}

/* Stats Card */
.stats-card .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.stat {
    text-align: center;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    border: 1px solid rgba(71, 85, 105, 0.3);
    transition: all 0.3s;
}

.stat:hover {
    border-color: #6366f1;
    transform: scale(1.05);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.25rem;
    line-height: 1;
}

.stat-label {
    color: #94a3b8;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Chart Cards */
.chart-card {
    grid-column: span 2;
    min-height: 350px;
}

@media (max-width: 1200px) {
    .chart-card {
        grid-column: span 1;
    }
}

.chart-container {
    height: 300px;
    position: relative;
    width: 100%;
}

.chart-container canvas {
    max-height: 100%;
    max-width: 100%;
}

/* Chart Controls */
.chart-controls {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    justify-content: flex-end;
}

.chart-btn {
    padding: 0.25rem 0.75rem;
    background: rgba(51, 65, 85, 0.5);
    border: 1px solid #475569;
    border-radius: 4px;
    color: #94a3b8;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.chart-btn:hover {
    background: rgba(99, 102, 241, 0.2);
    border-color: #6366f1;
    color: #f8fafc;
}

.chart-btn.active {
    background: rgba(99, 102, 241, 0.3);
    border-color: #6366f1;
    color: #f8fafc;
}

/* Activity Card */
.activity-card {
    grid-row: span 2;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.activity-list::-webkit-scrollbar {
    width: 6px;
}

.activity-list::-webkit-scrollbar-track {
    background: rgba(51, 65, 85, 0.3);
    border-radius: 3px;
}

.activity-list::-webkit-scrollbar-thumb {
    background: #475569;
    border-radius: 3px;
}

.activity-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.2);
    border-radius: 8px;
    border: 1px solid transparent;
    transition: all 0.3s;
}

.activity-item:hover {
    background: rgba(51, 65, 85, 0.4);
    border-color: #475569;
}

.activity-item.loading {
    opacity: 0.7;
    pointer-events: none;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1.25rem;
}

.activity-icon.success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.activity-icon.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.activity-icon.warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-title {
    font-weight: 500;
    color: #f8fafc;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.activity-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.activity-text {
    color: #94a3b8;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

.activity-time {
    color: #64748b;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
}

/* Health Card */
.health-card .health-metrics {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.health-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    border: 1px solid rgba(71, 85, 105, 0.3);
}

.health-label {
    color: #f8fafc;
    font-weight: 500;
}

.health-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #94a3b8;
    font-size: 0.875rem;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.status-dot.healthy {
    background: #10b981;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

.status-dot.warning {
    background: #f59e0b;
    box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
}

.status-dot.unhealthy {
    background: #ef4444;
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

.status-dot.unknown {
    background: #64748b;
}

/* Metrics Card */
.metrics-card .metrics-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.metric {
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid rgba(71, 85, 105, 0.3);
}

.metric-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    color: #f8fafc;
    font-weight: 500;
}

.metric-value {
    color: #94a3b8;
    font-size: 0.875rem;
}

.metric-progress {
    height: 6px;
    background: #334155;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 0.25rem;
}

.metric-progress .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 3px;
    transition: width 0.5s ease;
    position: relative;
}

.metric-progress .progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Quick Actions */
.quick-actions {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.quick-actions h3 {
    margin: 0 0 1.5rem 0;
    color: #f8fafc;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.action-btn {
    background: rgba(51, 65, 85, 0.5);
    border: 1px solid #475569;
    border-radius: 8px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    transition: all 0.3s;
    color: #f8fafc;
    text-decoration: none;
}

.action-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: #6366f1;
    transform: translateY(-2px);
}

.action-btn i {
    font-size: 2rem;
    color: #6366f1;
}

.action-btn span {
    font-weight: 500;
    font-size: 0.95rem;
}

/* Loading States */
.loading-shimmer {
    background: linear-gradient(90deg, 
        #1e293b 25%, 
        #2d3748 50%, 
        #1e293b 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Chart Placeholder */
.chart-placeholder {
    background: linear-gradient(90deg, 
        #1e293b 25%, 
        #2d3748 50%, 
        #1e293b 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
}

/* Chart Tooltip */
.chart-tooltip {
    background: rgba(30, 41, 59, 0.95);
    border: 1px solid #475569;
    border-radius: 6px;
    padding: 0.75rem;
    color: #f8fafc;
    font-size: 0.875rem;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Responsive Design */
@media (max-width: 1024px) {
    .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .dashboard-header h1 {
        font-size: 2rem;
    }
    
    .dashboard-actions {
        justify-content: center;
    }
    
    .stats-card .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .chart-card {
        min-height: 300px;
    }
    
    .chart-container {
        height: 250px;
    }
}

@media (max-width: 480px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
    
    .activity-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
    
    .chart-container {
        height: 200px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-tachometer-alt"></i> System Dashboard</h1>
        <div class="dashboard-actions">
            <button class="btn btn-secondary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-primary" onclick="exportDashboardData()">
                <i class="fas fa-download"></i> Export Data
            </button>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Quick Stats -->
        <div class="dashboard-card stats-card">
            <h3><i class="fas fa-chart-bar"></i> Overview</h3>
            <div class="stats-grid" id="overview-stats">
                <div class="stat">
                    <div class="stat-value loading-shimmer" id="total-processed">-</div>
                    <div class="stat-label">Total Processed</div>
                </div>
                <div class="stat">
                    <div class="stat-value loading-shimmer" id="success-rate">-</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat">
                    <div class="stat-value loading-shimmer" id="avg-confidence">-</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat">
                    <div class="stat-value loading-shimmer" id="avg-time">-</div>
                    <div class="stat-label">Avg Time</div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="dashboard-card health-card">
            <h3><i class="fas fa-heartbeat"></i> System Health</h3>
            <div class="health-metrics" id="health-metrics">
                <div class="health-item">
                    <div class="health-label">API Status</div>
                    <div class="health-status">
                        <span class="status-dot loading-shimmer"></span>
                        <span id="api-status-text">Checking...</span>
                    </div>
                </div>
                <div class="health-item">
                    <div class="health-label">Database</div>
                    <div class="health-status">
                        <span class="status-dot loading-shimmer"></span>
                        <span id="db-status-text">Checking...</span>
                    </div>
                </div>
                <div class="health-item">
                    <div class="health-label">Storage</div>
                    <div class="health-status">
                        <span class="status-dot loading-shimmer"></span>
                        <span id="storage-status-text">Checking...</span>
                    </div>
                </div>
                <div class="health-item">
                    <div class="health-label">Models</div>
                    <div class="health-status">
                        <span class="status-dot loading-shimmer"></span>
                        <span id="model-status-text">Checking...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CPU/Memory Usage -->
        <div class="dashboard-card metrics-card">
            <h3><i class="fas fa-microchip"></i> System Metrics</h3>
            <div class="metrics-grid" id="system-metrics">
                <div class="metric">
                    <div class="metric-label">
                        <span>CPU Usage</span>
                        <span class="metric-value" id="cpu-value">-</span>
                    </div>
                    <div class="metric-progress">
                        <div class="progress-bar" id="cpu-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">
                        <span>Memory</span>
                        <span class="metric-value" id="memory-value">-</span>
                    </div>
                    <div class="metric-progress">
                        <div class="progress-bar" id="memory-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-label">
                        <span>Disk Space</span>
                        <span class="metric-value" id="disk-value">-</span>
                    </div>
                    <div class="metric-progress">
                        <div class="progress-bar" id="disk-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Statistics Chart -->
        <div class="dashboard-card chart-card">
            <div class="chart-header">
                <h3><i class="fas fa-line-chart"></i> Processing Statistics</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="dashboard.charts.processing.changeType('line')">Line</button>
                    <button class="chart-btn" onclick="dashboard.charts.processing.changeType('bar')">Bar</button>
                    <button class="chart-btn" onclick="dashboard.refreshCharts()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="processing-chart"></canvas>
            </div>
        </div>

        <!-- Engine Performance -->
        <div class="dashboard-card chart-card">
            <div class="chart-header">
                <h3><i class="fas fa-cogs"></i> Engine Performance</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="dashboard.charts.engines.changeType('pie')">Pie</button>
                    <button class="chart-btn" onclick="dashboard.charts.engines.changeType('doughnut')">Donut</button>
                    <button class="chart-btn" onclick="dashboard.refreshCharts()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="engine-chart"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-card activity-card">
            <h3><i class="fas fa-history"></i> Recent Activity</h3>
            <div class="activity-list" id="recent-activity">
                <div class="activity-item loading">
                    <div class="activity-icon"><i class="fas fa-spinner fa-spin"></i></div>
                    <div class="activity-content">
                        <div class="activity-title">Loading activities...</div>
                        <div class="activity-details">
                            <span class="activity-text">Fetching recent results</span>
                            <span class="activity-time">Just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        <div class="action-buttons">
            <a href="{{ url_for('upload_page') }}" class="action-btn">
                <i class="fas fa-upload"></i>
                <span>Upload Image</span>
            </a>
            <button class="action-btn" onclick="runSystemCleanup()">
                <i class="fas fa-broom"></i>
                <span>Cleanup System</span>
            </button>
            <button class="action-btn" onclick="showSystemConfig()">
                <i class="fas fa-cog"></i>
                <span>System Config</span>
            </button>
            <button class="action-btn" onclick="viewAllResults()">
                <i class="fas fa-database"></i>
                <span>View All Results</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===== DASHBOARD FUNCTIONALITY =====
class Dashboard {
    constructor() {
        this.charts = {
            processing: null,
            engines: null
        };
        this.data = {};
        this.updateInterval = null;
        this.isLoading = false;
        this.initialized = false;
        
        // Chart colors
        this.chartColors = {
            primary: 'rgba(99, 102, 241, 0.8)',
            secondary: 'rgba(139, 92, 246, 0.8)',
            success: 'rgba(16, 185, 129, 0.8)',
            warning: 'rgba(245, 158, 11, 0.8)',
            danger: 'rgba(239, 68, 68, 0.8)',
            info: 'rgba(6, 182, 212, 0.8)'
        };
        
        // Chart color schemes
        this.colorSchemes = [
            '#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444',
            '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#8b5cf6'
        ];
    }

    async init() {
        if (this.initialized) return;
        
        console.log('Initializing dashboard...');
        
        try {
            // Initialize Chart.js
            this.initializeCharts();
            
            // Load all data in parallel
            await Promise.all([
                this.loadStats(),
                this.loadHealth(),
                this.loadMetrics(),
                this.loadActivity(),
                this.loadChartData()
            ]);
            
            this.initialized = true;
            console.log('Dashboard initialized successfully');
            
            // Start auto-refresh
            this.startAutoRefresh();
            
        } catch (error) {
            console.error('Dashboard initialization failed:', error);
            this.showError('dashboard', 'Failed to initialize dashboard');
        }
    }

async loadStats() {
    try {
        this.showLoading('stats');
        console.log('Loading stats...');
        
        // Try the main stats endpoint
        let response = await fetch('/api/system/stats');
        
        if (!response.ok) {
            console.log('System stats failed, trying results stats...');
            // Fallback to results stats
            response = await fetch('/api/results/stats');
            
            if (!response.ok) {
                // Try getting results directly
                const resultsResponse = await fetch('/api/results?per_page=100');
                if (resultsResponse.ok) {
                    const resultsData = await resultsResponse.json();
                    this.calculateStatsFromResults(resultsData.results || []);
                    return;
                }
                
                throw new Error('No stats endpoints available');
            }
        }
        
        const data = await response.json();
        console.log('Stats loaded:', data);
        
        // Handle different response formats
        if (data.overview || data.database) {
            this.updateStats(data);
        } else {
            // Try to convert format
            const convertedData = {
                overview: {
                    total_results: data.total_results || data.database?.total_results || 0,
                    success_rate: data.success_rate || data.database?.success_rate || 0,
                    avg_confidence: data.avg_confidence || data.database?.avg_confidence || 0,
                    avg_processing_time: data.avg_processing_time || 0.5
                },
                engine_stats: data.engine_stats || data.engines || {},
                daily_stats: data.daily_stats || data.daily || []
            };
            this.updateStats(convertedData);
        }
        
    } catch (error) {
        console.error('Failed to load stats:', error);
        this.updateStatsWithDefaults();
    } finally {
        this.hideLoading('stats');
    }
}
calculateStatsFromResults(results) {
    if (!results || results.length === 0) {
        this.updateStatsWithDefaults();
        return;
    }
    
    const total = results.length;
    const successCount = results.filter(r => r.success !== false).length;
    const successRate = (successCount / total) * 100;
    
    const confidences = results
        .map(r => r.best_ocr_confidence || 0)
        .filter(c => c > 0);
    const avgConfidence = confidences.length > 0 ? 
        (confidences.reduce((a, b) => a + b, 0) / confidences.length) * 100 : 0;
    
    const processingTimes = results
        .map(r => r.processing_time_ms || 500)
        .filter(t => t > 0);
    const avgTime = processingTimes.length > 0 ? 
        (processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length) / 1000 : 0.5;
    
    const stats = {
        overview: {
            total_results: total,
            success_rate: successRate,
            avg_confidence: avgConfidence / 100, // Convert to decimal for updateStats
            avg_processing_time: avgTime
        },
        daily_stats: [],
        engine_stats: {}
    };
    
    this.updateStats(stats);
}
    updateStatsWithDefaults() {
        // Set default values when stats are not available
        const elements = {
            'total-processed': '0',
            'success-rate': '0%',
            'avg-confidence': '0%',
            'avg-time': '0s'
        };
        
        for (const [id, value] of Object.entries(elements)) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
                el.className = 'stat-value';
            }
        }
    }

    async loadActivity() {
        try {
            const response = await fetch('/api/results?per_page=5');
            
            if (!response.ok) {
                if (response.status === 500 || response.status === 404) {
                    console.log('Activity endpoint not available yet');
                    this.updateActivity([]);
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            this.updateActivity(data.results || []);
            
        } catch (error) {
            console.error('Failed to load activity:', error);
            this.updateActivity([]);
        }
    }

    async loadHealth() {
        try {
            const response = await fetch('/api/health');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            this.updateHealth(data);
        } catch (error) {
            console.error('Failed to load health:', error);
            this.updateHealthStatus('error');
        }
    }
async loadMetrics() {
    try {
        console.log('Loading system metrics...');
        
        // Try primary endpoint
        let response = await fetch('/api/system/metrics');
        
        if (!response.ok) {
            // Fallback to health endpoint
            console.log('Primary metrics failed, trying health endpoint...');
            response = await fetch('/api/system/health-metrics');
            
            if (!response.ok) {
                response = await fetch('/api/health');
            }
        }
        
        const data = await response.json();
        console.log('Metrics data received:', data);
        
        // Handle different response formats
        if (data.cpu || data.system || data.cpu_percent) {
            this.updateMetrics(data);
        } else {
            console.warn('Unexpected metrics format:', data);
            // Try to extract from whatever format we got
            this.updateMetrics({
                cpu: { percent: data.cpu_percent || 0 },
                memory: { 
                    percent: data.memory_percent || data.system?.memory_percent || 0,
                    used_mb: (data.memory_used_gb || data.system?.memory_used_gb || 0) * 1024
                },
                disk: {
                    percent: data.disk_usage || data.system?.disk_usage || 0,
                    used_gb: data.disk_used_gb || data.system?.disk_used_gb || 0
                }
            });
        }
        
    } catch (error) {
        console.error('Failed to load metrics:', error);
        // Use demo data
        this.updateMetricsWithDemoData();
    }
}
 
    async loadChartData() {
        try {
            console.log('Loading chart data...');
            const response = await fetch('/api/results/stats');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            console.log('Chart data loaded:', data);
            this.updateCharts(data);
            
        } catch (error) {
            console.error('Failed to load chart data:', error);
            this.showChartError();
        }
    }

 updateStats(data) {
    console.log('Stats data received:', data);
    
    const stats = data.overview || {};
    
    // Update total processed
    const totalEl = document.getElementById('total-processed');
    if (totalEl) {
        totalEl.textContent = stats.total_results?.toLocaleString() || '0';
        totalEl.className = 'stat-value';
    }
    
    // Update success rate
    const successRateEl = document.getElementById('success-rate');
    if (successRateEl) {
        const successRate = stats.success_rate || 0;
        successRateEl.textContent = `${successRate.toFixed(1)}%`;
        successRateEl.className = 'stat-value';
        successRateEl.style.color = successRate > 90 ? '#10b981' : 
                                   successRate > 70 ? '#f59e0b' : '#ef4444';
    }
    
    // Update average confidence
    const avgConfEl = document.getElementById('avg-confidence');
    if (avgConfEl) {
        const conf = stats.avg_confidence || 0;
        // Convert to percentage if needed
        const confPercent = conf < 1 ? conf * 100 : conf;
        avgConfEl.textContent = `${confPercent.toFixed(1)}%`;
        avgConfEl.className = 'stat-value';
        avgConfEl.style.color = confPercent > 80 ? '#10b981' : 
                                confPercent > 60 ? '#f59e0b' : '#ef4444';
    }
    
    // Update average time
    const avgTimeEl = document.getElementById('avg-time');
    if (avgTimeEl) {
        const avgTime = stats.avg_processing_time || 0.5;
        avgTimeEl.textContent = `${avgTime.toFixed(2)}s`;
        avgTimeEl.className = 'stat-value';
        avgTimeEl.style.color = avgTime < 1 ? '#10b981' : 
                                avgTime < 3 ? '#f59e0b' : '#ef4444';
    }
    
    // Update charts with engine stats
    if (this.charts.engines && data.engine_stats) {
        const engineStats = data.engine_stats || {};
        const labels = Object.keys(engineStats);
        const counts = labels.map(label => engineStats[label]?.count || 0);
        
        // Filter out engines with 0 count
        const validIndices = counts.map((count, index) => count > 0 ? index : -1).filter(i => i !== -1);
        const validLabels = validIndices.map(i => labels[i]);
        const validCounts = validIndices.map(i => counts[i]);
        
        if (validLabels.length > 0) {
            this.charts.engines.data.labels = validLabels;
            this.charts.engines.data.datasets[0].data = validCounts;
            this.charts.engines.update();
        }
    }
    
    // Update processing chart with daily stats
    if (this.charts.processing && data.daily_stats) {
        const dailyStats = data.daily_stats || [];
        const labels = dailyStats.map(stat => {
            const date = stat.date ? new Date(stat.date) : new Date();
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const counts = dailyStats.map(stat => stat.count || 0);
        
        this.charts.processing.data.labels = labels;
        this.charts.processing.data.datasets[0].data = counts;
        this.charts.processing.update();
    }
}

 updateHealth(data) {
    const components = data.components || {};
    
    console.log('Health components received:', components);
    
    // Show what we actually get
    this.updateHealthElement('api', components.api === true, 'API');
    this.updateHealthElement('db', components.database === true, 'Database');
    this.updateHealthElement('storage', components.storage === true, 'Storage');
    
    // Models - check both YOLO and Transformer
    const modelsHealthy = components.yolo_detector === true || 
                         components.transformer_detector === true;
    this.updateHealthElement('model', modelsHealthy, 'Models');
}
updateHealthElement(id, isHealthy, label) {
    console.log(`Updating ${id}:`, isHealthy, label);
    
    const dot = document.querySelector(`#${id}-status-text`)?.previousElementSibling;
    const text = document.getElementById(`${id}-status-text`);
    
    if (dot && text) {
        if (isHealthy === true || isHealthy === false) {
            dot.className = `status-dot ${isHealthy ? 'healthy' : 'unhealthy'}`;
            text.textContent = isHealthy ? 'Healthy' : 'Unhealthy';
            text.style.color = isHealthy ? '#10b981' : '#ef4444';
        } else {
            // Unknown status
            dot.className = 'status-dot unknown';
            text.textContent = 'Checking...';
            text.style.color = '#64748b';
        }
    }
}
    updateSystemStatus(allHealthy) {
        const systemStatus = window.document.querySelector('.system-status');
        if (systemStatus) {
            const indicator = systemStatus.querySelector('.status-indicator');
            const text = systemStatus.querySelector('.status-text');
            
            if (allHealthy) {
                indicator.className = 'status-indicator status-healthy';
                text.textContent = 'System Healthy';
                text.style.color = '#10b981';
            } else {
                indicator.className = 'status-indicator status-unhealthy';
                text.textContent = 'System Issues';
                text.style.color = '#ef4444';
            }
        }
    }

 updateMetrics(data) {
    console.log('Metrics data:', data);
    
    // CPU - with fallback to psutil
    const cpuPercent = data.cpu?.percent || 
                      data.system?.cpu_percent || 
                      data.metrics?.cpu || 0;
    const cpuProgress = document.getElementById('cpu-progress');
    const cpuValue = document.getElementById('cpu-value');
    
    if (cpuProgress) {
        cpuProgress.style.width = `${Math.min(cpuPercent, 100)}%`;
        cpuProgress.style.background = cpuPercent > 80 ? 
            'linear-gradient(90deg, #ef4444, #f87171)' :
            cpuPercent > 60 ?
            'linear-gradient(90deg, #f59e0b, #fbbf24)' :
            'linear-gradient(90deg, #6366f1, #8b5cf6)';
    }
    
    if (cpuValue) {
        cpuValue.textContent = `${cpuPercent.toFixed(1)}%`;
    }
    
    // Memory - with multiple fallback options
    const memoryPercent = data.memory?.percent || 
                         data.system?.memory_percent || 
                         data.metrics?.memory || 0;
    const memoryUsed = data.memory?.used_mb || 
                      data.memory?.used / (1024*1024) || 
                      data.system?.memory_used_gb * 1024 || 
                      0;
    const memoryProgress = document.getElementById('memory-progress');
    const memoryValue = document.getElementById('memory-value');
    
    if (memoryProgress) {
        memoryProgress.style.width = `${Math.min(memoryPercent, 100)}%`;
        memoryProgress.style.background = memoryPercent > 80 ?
            'linear-gradient(90deg, #ef4444, #f87171)' :
            memoryPercent > 60 ?
            'linear-gradient(90deg, #f59e0b, #fbbf24)' :
            'linear-gradient(90deg, #6366f1, #8b5cf6)';
    }
    
    if (memoryValue) {
        if (memoryUsed > 1024) {
            memoryValue.textContent = `${(memoryUsed / 1024).toFixed(1)} GB`;
        } else {
            memoryValue.textContent = `${memoryUsed.toFixed(0)} MB`;
        }
    }
    
    // Disk - with fallbacks
    const diskPercent = data.disk?.percent || 
                       data.system?.disk_usage || 
                       data.storage?.percent || 0;
    const diskUsed = data.disk?.used_gb || 
                    data.disk?.used / (1024**3) || 
                    data.system?.disk_used_gb || 
                    0;
    const diskProgress = document.getElementById('disk-progress');
    const diskValue = document.getElementById('disk-value');
    
    if (diskProgress) {
        diskProgress.style.width = `${Math.min(diskPercent, 100)}%`;
        diskProgress.style.background = diskPercent > 90 ?
            'linear-gradient(90deg, #ef4444, #f87171)' :
            diskPercent > 80 ?
            'linear-gradient(90deg, #f59e0b, #fbbf24)' :
            'linear-gradient(90deg, #6366f1, #8b5cf6)';
    }
    
    if (diskValue) {
        diskValue.textContent = `${diskUsed.toFixed(1)} GB`;
    }
    
    // If all values are 0, show a warning
    if (cpuPercent === 0 && memoryPercent === 0 && diskPercent === 0) {
        console.warn('All metrics returned 0 - system metrics may not be working');
        
        // Try to load metrics via alternative endpoint
        setTimeout(() => {
            this.loadMetricsAlternative();
        }, 1000);
    }
}

async loadMetricsAlternative() {
    try {
        // Try alternative metrics endpoints
        const endpoints = [
            '/api/health',
            '/api/system/health',
            '/api/system/info'
        ];
        
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint);
                if (response.ok) {
                    const data = await response.json();
                    // Extract metrics from health endpoint
                    if (data.system) {
                        const metrics = {
                            cpu: { percent: data.system.cpu_percent || 0 },
                            memory: { 
                                percent: data.system.memory_percent || 0,
                                used_mb: (data.system.memory_available_gb || 0) * 1024
                            },
                            disk: { 
                                percent: data.system.disk_usage || 0,
                                used_gb: data.system.disk_used_gb || 0
                            }
                        };
                        this.updateMetrics(metrics);
                        return;
                    }
                }
            } catch (e) {
                console.log(`Endpoint ${endpoint} failed:`, e);
            }
        }
        
        // If no endpoints work, use mock data for demo
        this.updateMetricsWithDemoData();
        
    } catch (error) {
        console.error('Alternative metrics failed:', error);
        this.updateMetricsWithDemoData();
    }
}

updateMetricsWithDemoData() {
    // Use realistic demo data
    const demoData = {
        cpu: { percent: 45.5 },
        memory: { percent: 68.2, used_mb: 8192 },
        disk: { percent: 32.7, used_gb: 128.4 }
    };
    
    // Update UI with demo data
    const cpuValue = document.getElementById('cpu-value');
    const memoryValue = document.getElementById('memory-value');
    const diskValue = document.getElementById('disk-value');
    
    if (cpuValue) cpuValue.textContent = '45.5%';
    if (memoryValue) memoryValue.textContent = '8.0 GB';
    if (diskValue) diskValue.textContent = '128.4 GB';
    
    // Update progress bars
    const cpuProgress = document.getElementById('cpu-progress');
    const memoryProgress = document.getElementById('memory-progress');
    const diskProgress = document.getElementById('disk-progress');
    
    if (cpuProgress) cpuProgress.style.width = '45.5%';
    if (memoryProgress) memoryProgress.style.width = '68.2%';
    if (diskProgress) diskProgress.style.width = '32.7%';
}
    updateActivity(results) {
        const container = document.getElementById('recent-activity');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!results || results.length === 0) {
            container.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon success">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">No recent activity</div>
                        <div class="activity-details">
                            <span class="activity-text">Start by uploading an image</span>
                            <span class="activity-time">Just now</span>
                        </div>
                    </div>
                </div>
            `;
            return;
        }
        
        results.forEach(result => {
            const item = this.createActivityItem(result);
            container.appendChild(item);
        });
    }

    createActivityItem(result) {
        const item = document.createElement('div');
        item.className = 'activity-item';
        
        const isSuccess = result.success !== false;
        const iconType = isSuccess ? 'success' : 'error';
        const icon = isSuccess ? 'check-circle' : 'exclamation-circle';
        const text = result.best_ocr_text || result.error || 'Processing completed';
        const time = this.formatTime(result.timestamp);
        const filename = result.filename || 'Unknown file';
        
        item.innerHTML = `
            <div class="activity-icon ${iconType}">
                <i class="fas fa-${icon}"></i>
            </div>
            <div class="activity-content">
                <div class="activity-title">${this.escapeHtml(filename)}</div>
                <div class="activity-details">
                    <span class="activity-text">${this.escapeHtml(text)}</span>
                    <span class="activity-time">${time}</span>
                </div>
            </div>
        `;
        
        return item;
    }

    initializeCharts() {
        console.log('Initializing charts...');
        
        // Processing Statistics Chart
        const processingCtx = document.getElementById('processing-chart')?.getContext('2d');
        if (processingCtx) {
            this.charts.processing = new Chart(processingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Processed Images',
                        data: [],
                        borderColor: this.chartColors.primary,
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: this.chartColors.primary,
                        pointBorderColor: '#1e293b',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: this.getLineChartOptions('Processed Images (Last 7 Days)')
            });
        }

        // Engine Performance Chart
        const engineCtx = document.getElementById('engine-chart')?.getContext('2d');
        if (engineCtx) {
            this.charts.engines = new Chart(engineCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: this.colorSchemes,
                        borderColor: '#1e293b',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: this.getPieChartOptions('OCR Engine Usage')
            });
        }
    }

    updateCharts(data) {
        console.log('Updating charts with data:', data);
        
        // Update Processing Statistics Chart
        if (this.charts.processing && data.daily_stats) {
            const dailyStats = data.daily_stats || [];
            const labels = dailyStats.map(stat => {
                const date = stat.date ? new Date(stat.date) : new Date();
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const counts = dailyStats.map(stat => stat.count || 0);
            
            this.charts.processing.data.labels = labels;
            this.charts.processing.data.datasets[0].data = counts;
            this.charts.processing.update();
        }

        // Update Engine Performance Chart
        if (this.charts.engines && data.engine_stats) {
            const engineStats = data.engine_stats || {};
            const labels = Object.keys(engineStats);
            const counts = labels.map(label => engineStats[label]?.count || 0);
            
            // Only show engines with data
            const validIndices = counts.map((count, index) => count > 0 ? index : -1).filter(i => i !== -1);
            const validLabels = validIndices.map(i => labels[i]);
            const validCounts = validIndices.map(i => counts[i]);
            const validColors = validIndices.map(i => this.colorSchemes[i % this.colorSchemes.length]);
            
            this.charts.engines.data.labels = validLabels;
            this.charts.engines.data.datasets[0].data = validCounts;
            this.charts.engines.data.datasets[0].backgroundColor = validColors;
            this.charts.engines.update();
        }
    }

    showChartError() {
        // Show error message in charts
        const charts = ['processing-chart', 'engine-chart'];
        charts.forEach(chartId => {
            const container = document.getElementById(chartId)?.parentElement;
            if (container) {
                container.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100%;
                        color: #94a3b8;
                        text-align: center;
                        padding: 2rem;
                    ">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #f59e0b;"></i>
                        <p>Failed to load chart data</p>
                        <button class="chart-btn" onclick="dashboard.loadChartData()" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
        });
    }

    getLineChartOptions(title) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#94a3b8',
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    titleColor: '#f8fafc',
                    bodyColor: '#94a3b8',
                    borderColor: '#475569',
                    borderWidth: 1,
                    cornerRadius: 6,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return `Images: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(71, 85, 105, 0.3)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(71, 85, 105, 0.3)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) {
                            return value;
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                duration: 750,
                easing: 'easeOutQuart'
            }
        };
    }

    getPieChartOptions(title) {
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'right',
                    labels: {
                        color: '#94a3b8',
                        font: {
                            size: 12
                        },
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    titleColor: '#f8fafc',
                    bodyColor: '#94a3b8',
                    borderColor: '#475569',
                    borderWidth: 1,
                    cornerRadius: 6,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '50%',
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 750
            }
        };
    }

    formatTime(timestamp) {
        if (!timestamp) return 'Just now';
        
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return date.toLocaleDateString();
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    showLoading(section) {
        const elements = {
            stats: ['total-processed', 'success-rate', 'avg-confidence', 'avg-time'],
            charts: ['processing-chart', 'engine-chart']
        };
        
        if (elements[section]) {
            elements[section].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.className = el.className.includes('loading') ? el.className : el.className + ' loading-shimmer';
            });
        }
    }

    hideLoading(section) {
        const elements = {
            stats: ['total-processed', 'success-rate', 'avg-confidence', 'avg-time']
        };
        
        if (elements[section]) {
            elements[section].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.className.includes('loading')) {
                    el.className = el.className.replace('loading-shimmer', '').trim();
                }
            });
        }
    }

    showError(section, message) {
        if (typeof window.showNotification === 'function') {
            window.showNotification(message, 'error');
        } else {
            console.error(message);
        }
    }

    startAutoRefresh() {
        // Refresh every 30 seconds
        this.updateInterval = setInterval(() => {
            this.refresh();
        }, 30000);
    }

    stopAutoRefresh() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
            this.updateInterval = null;
        }
    }

    async refresh() {
        if (this.isLoading) return;
        
        this.isLoading = true;
        try {
            await Promise.all([
                this.loadStats(),
                this.loadMetrics(),
                this.loadActivity(),
                this.loadChartData()
            ]);
            
            if (typeof window.showNotification === 'function') {
                window.showNotification('Dashboard refreshed', 'success');
            }
            
        } finally {
            this.isLoading = false;
        }
    }

    async refreshCharts() {
        await this.loadChartData();
        if (typeof window.showNotification === 'function') {
            window.showNotification('Charts refreshed', 'success');
        }
    }

    async exportData() {
        try {
            const response = await fetch('/api/results/export?format=json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-export-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            if (typeof window.showNotification === 'function') {
                window.showNotification('Data exported successfully', 'success');
            }
        } catch (error) {
            console.error('Export failed:', error);
            if (typeof window.showNotification === 'function') {
                window.showNotification('Failed to export data', 'error');
            }
        }
    }

    async cleanup() {
        if (!confirm('This will remove old files and temporary data. Continue?')) return;
        
        try {
            const response = await fetch('/api/system/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: 7 })
            });
            
            const data = await response.json();
            if (typeof window.showNotification === 'function') {
                window.showNotification(data.message || 'Cleanup completed', 'success');
            }
            this.refresh();
        } catch (error) {
            if (typeof window.showNotification === 'function') {
                window.showNotification('Cleanup failed', 'error');
            }
        }
    }
}

// Initialize dashboard
let dashboard;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing dashboard...');
    dashboard = new Dashboard();
    
    // Set a timeout to ensure everything is loaded
    setTimeout(() => {
        dashboard.init();
    }, 100);
    
    // Set up chart type switching
    setupChartControls();
});

function setupChartControls() {
    // Processing chart controls
    document.querySelectorAll('.chart-controls .chart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const parent = this.closest('.chart-card');
            const otherBtns = parent.querySelectorAll('.chart-btn');
            otherBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

// Global functions for template onclick handlers
function refreshDashboard() {
    if (dashboard) dashboard.refresh();
}

function exportDashboardData() {
    if (dashboard) dashboard.exportData();
}

function runSystemCleanup() {
    if (dashboard) dashboard.cleanup();
}

function showSystemConfig() {
    fetch('/api/system/config')
        .then(response => response.json())
        .then(config => {
            // Create a modal to show config
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: #1e293b;
                    border: 1px solid #475569;
                    border-radius: 12px;
                    padding: 2rem;
                    max-width: 800px;
                    max-height: 80vh;
                    overflow-y: auto;
                    width: 90%;
                ">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 1.5rem;
                    ">
                        <h3 style="margin: 0; color: #f8fafc;">
                            <i class="fas fa-cog"></i> System Configuration
                        </h3>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="
                                    background: none;
                                    border: none;
                                    color: #94a3b8;
                                    font-size: 1.5rem;
                                    cursor: pointer;
                                ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <pre style="
                        background: #0f172a;
                        padding: 1rem;
                        border-radius: 8px;
                        color: #cbd5e1;
                        font-size: 0.875rem;
                        overflow-x: auto;
                        max-height: 60vh;
                    ">${JSON.stringify(config, null, 2)}</pre>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on escape
            const closeModal = () => modal.remove();
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        })
        .catch(() => {
            if (typeof window.showNotification === 'function') {
                window.showNotification('Failed to load configuration', 'error');
            }
        });
}

function viewAllResults() {
    window.location.href = '/results';
}

// Add notification function if not exists
if (typeof window.showNotification === 'undefined') {
    window.showNotification = function(message, type = 'info') {
        console.log(`${type}: ${message}`);
        alert(`${type.toUpperCase()}: ${message}`);
    };
}
</script>
{% endblock %}