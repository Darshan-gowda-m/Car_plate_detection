{% extends "layout.html" %}

{% block title %}Upload Image - Plate Detection{% endblock %}

{% block extra_css %}
<style>
/* ===== UPLOAD PAGE STYLES ===== */
.upload-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.upload-header {
    text-align: center;
    margin-bottom: 3rem;
}

.upload-header h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.upload-subtitle {
    color: #94a3b8;
    font-size: 1.125rem;
}

/* Tabs */
.upload-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid #475569;
    padding-bottom: 1rem;
    flex-wrap: wrap;
}

.tab-btn {
    background: none;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    color: #94a3b8;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid transparent;
}

.tab-btn:hover {
    color: #f8fafc;
    background: rgba(99, 102, 241, 0.1);
}

.tab-btn.active {
    color: #6366f1;
    background: rgba(99, 102, 241, 0.1);
    border-color: #6366f1;
}

/* Upload Sections */
.upload-section {
    display: none;
}

.upload-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Upload Area */
.upload-area {
    border: 2px dashed #475569;
    border-radius: 16px;
    padding: 4rem 2rem;
    text-align: center;
    transition: all 0.3s;
    margin-bottom: 2rem;
    background: rgba(30, 41, 59, 0.5);
    cursor: pointer;
}

.upload-area:hover {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.05);
}

.upload-area.highlight {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.1);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 4rem;
    color: #6366f1;
    margin-bottom: 1rem;
}

.upload-area h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.upload-area p {
    color: #94a3b8;
    margin-bottom: 1.5rem;
}

.upload-hint {
    font-size: 0.875rem;
    margin-top: 1rem;
    color: #64748b;
}

/* Preview Section */
.preview-section {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 2rem;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #475569;
    background: rgba(30, 41, 59, 0.8);
}

.preview-header h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.preview-container {
    padding: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
}

.preview-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #64748b;
    gap: 1rem;
}

.preview-placeholder i {
    font-size: 4rem;
}

.preview-image {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
}

.file-info {
    padding: 1rem 1.5rem;
    border-top: 1px solid #475569;
    background: rgba(30, 41, 59, 0.5);
}

.info-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(71, 85, 105, 0.3);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    color: #94a3b8;
    font-weight: 500;
}

.info-value {
    color: #f8fafc;
    font-family: 'JetBrains Mono', monospace;
}

/* URL Input */
.url-input-section {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
}

.input-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.input-group .form-control {
    flex: 1;
}

.url-preview {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    overflow: hidden;
}

/* Camera Section */
.camera-section {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
}

.camera-preview {
    width: 100%;
    height: 400px;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 12px;
    margin-bottom: 2rem;
    overflow: hidden;
    position: relative;
}

.camera-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #64748b;
    gap: 1rem;
}

.camera-placeholder i {
    font-size: 4rem;
}

#camera-stream {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.camera-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

/* Options Section */
.options-section {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
}

.options-section h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.option-group {
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
}

.option-group h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    color: #f8fafc;
}

.option {
    margin-bottom: 1.25rem;
}

.option:last-child {
    margin-bottom: 0;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
    margin-bottom: 0.25rem;
}

.checkbox-label input[type="checkbox"] {
    margin-top: 0.25rem;
    accent-color: #6366f1;
    cursor: pointer;
    width: 18px;
    height: 18px;
}

.checkbox-label span {
    flex: 1;
    color: #f8fafc;
    font-weight: 500;
}

.checkbox-label small {
    display: block;
    color: #94a3b8;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    margin-left: 1.75rem;
}

/* Action Section */
.action-section {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin: 3rem 0;
    padding: 2rem;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 12px;
}

.action-section .btn-lg {
    padding: 1rem 2.5rem;
    font-size: 1.1rem;
}

/* Results Section */
.results-section {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
}

.results-section h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.results-container {
    min-height: 300px;
}

.results-loading {
    text-align: center;
    padding: 4rem 2rem;
}

.results-loading .loading-spinner {
    margin-bottom: 2rem;
}

.results-loading .spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(99, 102, 241, 0.3);
    border-radius: 50%;
    border-top-color: #6366f1;
    margin: 0 auto 1rem;
    animation: spin 1s linear infinite;
}

.progress-container {
    max-width: 400px;
    margin: 0 auto;
}

.progress-bar {
    height: 8px;
    background: #334155;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    width: 0%;
    transition: width 0.3s ease;
}

.progress-text {
    display: flex;
    justify-content: space-between;
    color: #94a3b8;
    font-size: 0.875rem;
}

/* Results Content - UPDATED FOR NEW RESPONSE FORMAT */
.results-content {
    animation: fadeIn 0.5s ease;
}

.error-result, .warning-result, .success-result {
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.error-result {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.warning-result {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.success-result {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.error-result i, .warning-result i, .success-result i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.error-result i { color: #ef4444; }
.warning-result i { color: #f59e0b; }
.success-result i { color: #10b981; }

.result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #475569;
}

.result-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.result-id {
    font-size: 0.875rem;
    color: #94a3b8;
    font-family: 'JetBrains Mono', monospace;
}

.processing-time {
    background: rgba(99, 102, 241, 0.2);
    color: #6366f1;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
}

.quality-badge {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

/* Processing Summary */
.result-summary {
    background: rgba(30, 41, 59, 0.5);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.3);
    border-radius: 8px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #6366f1;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #94a3b8;
}

.summary-methods {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.method-badge {
    background: rgba(99, 102, 241, 0.2);
    color: #6366f1;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Plates Display */
.plates-section {
    margin-bottom: 2rem;
}

.plates-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: #f8fafc;
}

.plates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
}

.plate-card {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid #475569;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s;
}

.plate-card:hover {
    border-color: #6366f1;
    transform: translateY(-2px);
}

.plate-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.3);
    border-bottom: 1px solid #475569;
}

.plate-number {
    font-weight: 600;
    color: #f8fafc;
    font-size: 1.125rem;
}

.plate-confidence {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.plate-body {
    padding: 1rem;
}

.plate-ocr-result {
    margin-bottom: 1rem;
}

.ocr-text {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #f8fafc;
    font-family: 'JetBrains Mono', monospace;
}

.ocr-engine {
    color: #94a3b8;
    font-size: 0.875rem;
}

.plate-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.detail-label {
    color: #94a3b8;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    color: #f8fafc;
    font-size: 0.875rem;
    font-weight: 500;
}

.plate-images {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-top: 1rem;
}

.plate-image {
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid #475569;
}

.plate-image img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
}

.plate-image-label {
    font-size: 0.75rem;
    color: #94a3b8;
    text-align: center;
    padding: 0.25rem;
    background: rgba(51, 65, 85, 0.3);
}

/* OCR Engines Comparison */
.ocr-engines-section {
    margin-bottom: 2rem;
}

.ocr-engines-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: #f8fafc;
}

.ocr-engines-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.ocr-engine-card {
    background: rgba(51, 65, 85, 0.5);
    border: 1px solid #475569;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s;
}

.ocr-engine-card.best {
    border-color: #6366f1;
    background: rgba(99, 102, 241, 0.1);
}

.ocr-engine-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.ocr-engine-name {
    font-weight: 600;
    color: #f8fafc;
    text-transform: capitalize;
}

.ocr-confidence {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.ocr-engine-text {
    font-size: 1.125rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #f8fafc;
    font-family: 'JetBrains Mono', monospace;
}

/* Image Analysis */
.image-analysis-section {
    background: rgba(30, 41, 59, 0.5);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.analysis-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: #f8fafc;
}

.analysis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.analysis-item {
    background: rgba(51, 65, 85, 0.3);
    border-radius: 6px;
    padding: 1rem;
}

.analysis-label {
    color: #94a3b8;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}

.analysis-value {
    color: #f8fafc;
    font-size: 1rem;
    font-weight: 500;
}

.analysis-score {
    height: 6px;
    background: #334155;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.analysis-score-fill {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 3px;
}

/* Visualization */
.visualization-section {
    margin-bottom: 2rem;
}

.visualization-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: #f8fafc;
}

/* Add this to your CSS section */
.visualization-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.visualization-card {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid #475569;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s;
}

.visualization-card:hover {
    border-color: #6366f1;
    transform: translateY(-2px);
}

.visualization-card h5 {
    padding: 1rem;
    margin: 0;
    border-bottom: 1px solid #475569;
    background: rgba(51, 65, 85, 0.3);
    color: #f8fafc;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}

.visualization-image {
    padding: 1.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 250px;
    max-height: 400px;
    overflow: hidden;
}

.visualization-image img {
    max-width: 100%;
    max-height: 350px;
    border-radius: 6px;
    border: 1px solid #475569;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.visualization-image img:hover {
    transform: scale(1.02);
}

.visualization-scroll-container {
    display: flex;
    gap: 0.75rem;
    overflow-x: auto;
    padding: 1rem;
    scrollbar-width: thin;
    scrollbar-color: #6366f1 #1e293b;
}

.visualization-scroll-container::-webkit-scrollbar {
    height: 8px;
}

.visualization-scroll-container::-webkit-scrollbar-track {
    background: #1e293b;
    border-radius: 4px;
}

.visualization-scroll-container::-webkit-scrollbar-thumb {
    background: #6366f1;
    border-radius: 4px;
}

.visualization-scroll-item {
    flex: 0 0 auto;
    text-align: center;
    min-width: 120px;
}

.visualization-scroll-item img {
    width: 100%;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #475569;
}

.visualization-scroll-label {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 0.5rem;
    white-space: nowrap;
}

/* Action Buttons */
.result-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #475569;
    flex-wrap: wrap;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: #1e293b;
    border: 1px solid #475569;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #475569;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-close {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
}

.modal-close:hover {
    color: #f8fafc;
}

.modal-body {
    padding: 2rem;
}

.processing-steps {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.processing-step {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.step-number {
    width: 36px;
    height: 36px;
    background: #334155;
    color: #94a3b8;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
    transition: all 0.3s;
}

.processing-step.active .step-number {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
}

.processing-step.completed .step-number {
    background: #10b981;
    color: white;
}

.step-content {
    flex: 1;
}

.step-title {
    font-weight: 500;
    color: #f8fafc;
    margin-bottom: 0.25rem;
}

.step-status {
    font-size: 0.875rem;
    color: #94a3b8;
}

.processing-step.active .step-status {
    color: #6366f1;
}

.processing-step.completed .step-status {
    color: #10b981;
}

/* Responsive Design */
@media (max-width: 768px) {
    .upload-container {
        padding: 1rem;
    }
    
    .upload-header h1 {
        font-size: 2rem;
    }
    
    .upload-tabs {
        flex-direction: column;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
    
    .input-group {
        flex-direction: column;
    }
    
    .camera-preview {
        height: 300px;
    }
    
    .options-grid {
        grid-template-columns: 1fr;
    }
    
    .action-section {
        flex-direction: column;
    }
    
    .action-section .btn {
        width: 100%;
    }
    
    .result-actions {
        flex-direction: column;
    }
    
    .plates-grid {
        grid-template-columns: 1fr;
    }
    
    .summary-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .plate-details {
        grid-template-columns: 1fr;
    }
    
    .plate-images {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .upload-header h1 {
        font-size: 1.75rem;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .preview-container {
        padding: 1rem;
    }
    
    .camera-controls {
        flex-direction: column;
    }
    
    .summary-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-header">
        <h1><i class="fas fa-upload"></i> Upload Image</h1>
        <p class="upload-subtitle">Upload a single vehicle image for license plate detection</p>
    </div>

    <div class="upload-options">
        <div class="upload-tabs">
            <button class="tab-btn active" onclick="switchTab('single')">
                <i class="fas fa-file-upload"></i> Single Upload
            </button>
            <button class="tab-btn" onclick="switchTab('url')">
                <i class="fas fa-link"></i> From URL
            </button>
            <button class="tab-btn" onclick="switchTab('camera')">
                <i class="fas fa-camera"></i> Web Camera
            </button>
        </div>
    </div>

    <!-- Single File Upload -->
    <div id="single-upload" class="upload-section active">
        <div class="upload-area" id="dropzone">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3>Drag & Drop Image</h3>
            <p>or click to browse</p>
            <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.bmp,.tiff,.webp" style="display: none;">
            <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-folder-open"></i> Browse Files
            </button>
            <p class="upload-hint">Supports JPG, PNG, BMP, TIFF, WEBP (max 100MB)</p>
        </div>

        <div class="preview-section">
            <div class="preview-header">
                <h4><i class="fas fa-image"></i> Image Preview</h4>
                <button class="btn btn-sm btn-secondary" onclick="clearPreview()" id="clear-btn" style="display: none;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            <div class="preview-container">
                <div class="preview-placeholder" id="preview-placeholder">
                    <i class="fas fa-car"></i>
                    <p>No image selected</p>
                </div>
                <img id="image-preview" class="preview-image" style="display: none;">
            </div>
            <div class="file-info" id="file-info" style="display: none;">
                <div class="info-item">
                    <span class="info-label">Filename:</span>
                    <span class="info-value" id="info-filename"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Size:</span>
                    <span class="info-value" id="info-size"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Dimensions:</span>
                    <span class="info-value" id="info-dimensions"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- URL Upload -->
    <div id="url-upload" class="upload-section" style="display: none;">
        <div class="url-input-section">
            <div class="input-group">
                <input type="url" id="image-url" class="form-control" 
                       placeholder="https://example.com/vehicle-image.jpg" 
                       pattern="https?://.+">
                <button class="btn btn-primary" onclick="loadFromURL()">
                    <i class="fas fa-download"></i> Load Image
                </button>
            </div>
            <div class="url-preview">
                <img id="url-preview" class="preview-image" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Web Camera -->
    <div id="camera-upload" class="upload-section" style="display: none;">
        <div class="camera-section">
            <div class="camera-preview">
                <video id="camera-stream" autoplay playsinline style="display: none;"></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
                <div class="camera-placeholder" id="camera-placeholder">
                    <i class="fas fa-camera"></i>
                    <p>Camera feed will appear here</p>
                </div>
            </div>
            <div class="camera-controls">
                <button class="btn btn-primary" id="start-camera-btn" onclick="startCamera()">
                    <i class="fas fa-play"></i> Start Camera
                </button>
                <button class="btn btn-secondary" id="capture-btn" onclick="captureImage()" disabled>
                    <i class="fas fa-camera"></i> Capture Image
                </button>
                <button class="btn btn-danger" id="stop-camera-btn" onclick="stopCamera()" disabled>
                    <i class="fas fa-stop"></i> Stop Camera
                </button>
            </div>
        </div>
    </div>

    <!-- Processing Options -->
    <div class="options-section">
        <h3><i class="fas fa-sliders-h"></i> Processing Options</h3>
        
        <div class="options-grid">
            <div class="option-group">
                <h4><i class="fas fa-search"></i> Detection Settings</h4>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="use-yolo" checked>
                        <span>Use YOLO Detection</span>
                    </label>
                    <small>Primary detection using YOLOv11 model</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="use-fallback" checked>
                        <span>Use Fallback Detection</span>
                    </label>
                    <small>Computer vision methods if YOLO fails</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="multi-scale" checked>
                        <span>Multi-scale Detection</span>
                    </label>
                    <small>Detect at multiple image scales</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="use-transformer">
                        <span>Use Transformer Detection</span>
                    </label>
                    <small>Advanced DETR model for better accuracy</small>
                </div>
            </div>

            <div class="option-group">
                <h4><i class="fas fa-font"></i> OCR Settings</h4>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocr-easyocr" checked>
                        <span>EasyOCR</span>
                    </label>
                    <small>Fast and accurate for clean images</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocr-tesseract" checked>
                        <span>Tesseract OCR</span>
                    </label>
                    <small>Good for complex text layouts</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocr-google">
                        <span>Google Vision</span>
                    </label>
                    <small>Most accurate (requires API key)</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ocr-deep" checked>
                        <span>Deep OCR</span>
                    </label>
                    <small>Neural network based OCR</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="preprocess" checked>
                        <span>Image Preprocessing</span>
                    </label>
                    <small>Enhance image before OCR</small>
                </div>
            </div>

            <div class="option-group">
                <h4><i class="fas fa-download"></i> Output Settings</h4>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="save-output" checked>
                        <span>Save Output Files</span>
                    </label>
                    <small>Save cropped plates and visualizations</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="save-db" checked>
                        <span>Save to Database</span>
                    </label>
                    <small>Store results in database for analytics</small>
                </div>
                <div class="option">
                    <label class="checkbox-label">
                        <input type="checkbox" id="save-original" checked>
                        <span>Keep Original File</span>
                    </label>
                    <small>Keep uploaded file after processing</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-section">
        <button class="btn btn-primary btn-lg" id="process-btn" onclick="processImage()" disabled>
            <i class="fas fa-play-circle"></i> Process Image
        </button>
        <button class="btn btn-secondary btn-lg" onclick="resetForm()">
            <i class="fas fa-redo"></i> Reset
        </button>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="results-section" style="display: none;">
        <h3><i class="fas fa-chart-bar"></i> Processing Results</h3>
        
        <div class="results-container">
            <div class="results-loading" id="results-loading">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Processing image...</p>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="processing-progress"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progress-text">Initializing...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                </div>
            </div>

            <div class="results-content" id="results-content" style="display: none;">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal" id="processing-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-cogs"></i> Processing Image</h3>
            <button class="modal-close" onclick="closeProcessingModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="processing-steps">
                <div class="processing-step active" id="step-upload">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">Uploading Image</div>
                        <div class="step-status">Completed</div>
                    </div>
                </div>
                <div class="processing-step" id="step-detection">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">Plate Detection</div>
                        <div class="step-status">Pending</div>
                    </div>
                </div>
                <div class="processing-step" id="step-ocr">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">OCR Processing</div>
                        <div class="step-status">Pending</div>
                    </div>
                </div>
                <div class="processing-step" id="step-results">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">Generating Results</div>
                        <div class="step-status">Pending</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== UPLOAD PAGE FUNCTIONALITY =====
let currentTab = 'single';
let selectedFile = null;
let imageDataUrl = null;
let cameraStream = null;
let isProcessing = false;

// Tab switching
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.upload-section').forEach(section => {
        section.style.display = 'none';
    });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    const tabElement = document.getElementById(`${tabName}-upload`);
    if (tabElement) {
        tabElement.style.display = 'block';
        tabElement.classList.add('active');
    }
    
    document.querySelector(`.tab-btn[onclick*="${tabName}"]`).classList.add('active');
    currentTab = tabName;

    updateProcessButton();
}

// Enable/disable process button
function updateProcessButton() {
    const processBtn = document.getElementById('process-btn');
    let isEnabled = false;

    switch(currentTab) {
        case 'single':
            isEnabled = selectedFile !== null;
            break;
        case 'url':
        case 'camera':
            isEnabled = imageDataUrl !== null;
            break;
    }

    processBtn.disabled = !isEnabled || isProcessing;
}

// File upload handling
document.getElementById('file-input').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
    }
});

function handleFileUpload(file) {
    // Validate file
    if (!file.type.match('image.*')) {
        showNotification('Please select an image file (JPG, PNG, BMP, TIFF, WEBP)', 'error');
        return;
    }

    if (file.size > 100 * 1024 * 1024) {
        showNotification('File size must be less than 100MB', 'error');
        return;
    }

    selectedFile = file;
    previewImage(file);
    updateFileInfo(file);
    updateProcessButton();
    showNotification('Image loaded successfully!', 'success');
}

function previewImage(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('image-preview');
        const placeholder = document.getElementById('preview-placeholder');
        
        preview.src = e.target.result;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        document.getElementById('clear-btn').style.display = 'block';
        
        imageDataUrl = e.target.result;
    };
    reader.readAsDataURL(file);
}

function updateFileInfo(file) {
    const info = document.getElementById('file-info');
    info.style.display = 'block';
    
    document.getElementById('info-filename').textContent = file.name;
    document.getElementById('info-size').textContent = formatFileSize(file.size);
    
    // Get image dimensions
    const img = new Image();
    img.onload = function() {
        document.getElementById('info-dimensions').textContent = 
            `${this.width} × ${this.height} pixels`;
    };
    img.src = URL.createObjectURL(file);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function clearPreview() {
    selectedFile = null;
    imageDataUrl = null;
    
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('preview-placeholder').style.display = 'flex';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('clear-btn').style.display = 'none';
    document.getElementById('file-input').value = '';
    
    updateProcessButton();
    showNotification('Preview cleared', 'info');
}

// URL upload handling
async function loadFromURL() {
    const urlInput = document.getElementById('image-url');
    const url = urlInput.value.trim();
    
    if (!url) {
        showNotification('Please enter a valid image URL', 'error');
        return;
    }

    try {
        showNotification('Loading image from URL...', 'info');
        
        // Create image element
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = function() {
            // Create canvas to convert to data URL
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            imageDataUrl = canvas.toDataURL('image/jpeg');
            const preview = document.getElementById('url-preview');
            preview.src = imageDataUrl;
            preview.style.display = 'block';
            
            // Also update the main preview for consistency
            document.getElementById('image-preview').src = imageDataUrl;
            document.getElementById('image-preview').style.display = 'block';
            
            updateProcessButton();
            showNotification('Image loaded successfully from URL', 'success');
        };
        
        img.onerror = function() {
            throw new Error('Failed to load image from URL');
        };
        
        img.src = url;
        
    } catch (error) {
        console.error('URL load error:', error);
        showNotification('Failed to load image: ' + error.message, 'error');
    }
}

// Camera handling
async function startCamera() {
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        const video = document.getElementById('camera-stream');
        video.srcObject = cameraStream;
        video.style.display = 'block';
        
        document.getElementById('camera-placeholder').style.display = 'none';
        document.getElementById('start-camera-btn').disabled = true;
        document.getElementById('capture-btn').disabled = false;
        document.getElementById('stop-camera-btn').disabled = false;
        
        showNotification('Camera started successfully', 'success');
    } catch (error) {
        console.error('Camera error:', error);
        showNotification('Failed to access camera: ' + error.message, 'error');
    }
}

function captureImage() {
    const video = document.getElementById('camera-stream');
    const canvas = document.getElementById('camera-canvas');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    imageDataUrl = canvas.toDataURL('image/jpeg');
    
    // Switch to single upload tab to show preview
    switchTab('single');
    const preview = document.getElementById('image-preview');
    const placeholder = document.getElementById('preview-placeholder');
    preview.src = imageDataUrl;
    preview.style.display = 'block';
    placeholder.style.display = 'none';
    document.getElementById('clear-btn').style.display = 'block';
    
    // Update file info for captured image
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('info-filename').textContent = 'camera-capture.jpg';
    document.getElementById('info-size').textContent = formatFileSize(imageDataUrl.length * 0.75); // Approximate
    document.getElementById('info-dimensions').textContent = `${canvas.width} × ${canvas.height} pixels`;
    
    updateProcessButton();
    showNotification('Image captured from camera', 'success');
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    document.getElementById('camera-stream').style.display = 'none';
    document.getElementById('camera-placeholder').style.display = 'flex';
    document.getElementById('start-camera-btn').disabled = false;
    document.getElementById('capture-btn').disabled = true;
    document.getElementById('stop-camera-btn').disabled = true;
    
    showNotification('Camera stopped', 'info');
}

// Image processing
async function processImage() {
    if (isProcessing) return;
    
    // Validation
    if (currentTab === 'single' && !selectedFile) {
        showNotification('Please select an image first', 'error');
        return;
    }
    
    if ((currentTab === 'url' || currentTab === 'camera') && !imageDataUrl) {
        showNotification('Please load an image first', 'error');
        return;
    }
    
    isProcessing = true;
    updateProcessButton();
    
    // Show processing UI
    document.getElementById('processing-modal').style.display = 'flex';
    document.getElementById('results-section').style.display = 'block';
    document.getElementById('results-loading').style.display = 'block';
    document.getElementById('results-content').style.display = 'none';
    
    // Reset progress steps
    document.querySelectorAll('.processing-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    document.getElementById('step-upload').classList.add('active', 'completed');
    
    // Prepare form data
    const formData = new FormData();
    let fileToUpload = null;
    
    if (currentTab === 'single' && selectedFile) {
        fileToUpload = selectedFile;
    } else if (imageDataUrl) {
        // Convert data URL to blob
        const blob = dataURLtoBlob(imageDataUrl);
        fileToUpload = new File([blob], 'image.jpg', { type: 'image/jpeg' });
    }
    
    if (!fileToUpload) {
        showNotification('No valid image to process', 'error');
        isProcessing = false;
        updateProcessButton();
        closeProcessingModal();
        return;
    }
    
    formData.append('image', fileToUpload);
    
    // Add processing options
    const options = {
        detection: {
            confidence_threshold: 0.25,
            use_yolo: document.getElementById('use-yolo').checked,
            use_transformer: document.getElementById('use-transformer').checked,
            use_fallback: document.getElementById('use-fallback').checked,
            multi_scale: document.getElementById('multi-scale').checked
        },
        ocr: {
            engines: {
                easyocr: document.getElementById('ocr-easyocr').checked,
                tesseract: document.getElementById('ocr-tesseract').checked,
                google_vision: document.getElementById('ocr-google').checked,
                deep_ocr: document.getElementById('ocr-deep').checked
            },
            preprocess: document.getElementById('preprocess').checked
        },
        output: {
            save_files: document.getElementById('save-output').checked,
            save_to_db: document.getElementById('save-db').checked,
            save_original: document.getElementById('save-original').checked
        }
    };
    
    formData.append('options', JSON.stringify(options));
    
    try {
        // Step 1: Upload (already done in preview)
        updateProgress(10, 'Uploading image...');
        
        // Step 2: Detection
        updateProgress(30, 'Detecting license plates...');
        document.getElementById('step-detection').classList.add('active');
        
        // Use setTimeout to simulate progress for demo
        // In production, this would be actual API calls
        setTimeout(() => {
            document.getElementById('step-detection').classList.add('completed');
            document.getElementById('step-ocr').classList.add('active');
            
            // Step 3: OCR Processing
            updateProgress(60, 'Running OCR engines...');
            
            // Make actual API call
            fetch('/api/process/single', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Step 4: Generating Results
                updateProgress(90, 'Generating results...');
                document.getElementById('step-ocr').classList.add('completed');
                document.getElementById('step-results').classList.add('active');
                
                setTimeout(() => {
                    updateProgress(100, 'Processing complete!');
                    document.getElementById('step-results').classList.add('completed');
                    
                    // Display results
                    setTimeout(() => {
                        displayResults(data);
                        closeProcessingModal();
                        isProcessing = false;
                        updateProcessButton();
                        
                        // Scroll to results
                        document.getElementById('results-section').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 500);
                    
                }, 1000);
            })
            .catch(error => {
                console.error('Processing error:', error);
                showNotification('Processing failed: ' + error.message, 'error');
                closeProcessingModal();
                isProcessing = false;
                updateProcessButton();
                
                displayError(error);
            });
            
        }, 1500);
        
    } catch (error) {
        console.error('Processing error:', error);
        showNotification('Processing failed: ' + error.message, 'error');
        closeProcessingModal();
        isProcessing = false;
        updateProcessButton();
        
        displayError(error);
    }
}

function updateProgress(percent, text) {
    const progressBar = document.getElementById('processing-progress');
    const progressText = document.getElementById('progress-text');
    const progressPercent = document.getElementById('progress-percent');
    
    if (progressBar) progressBar.style.width = percent + '%';
    if (progressText) progressText.textContent = text;
    if (progressPercent) progressPercent.textContent = percent + '%';
}

function displayResults(data) {
    const resultsContent = document.getElementById('results-content');
    
    if (data.error) {
        // Display error
        resultsContent.innerHTML = `
            <div class="error-result">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Processing Failed</h4>
                <p>${data.error}</p>
                ${data.error_type ? `<p><small>Error type: ${data.error_type}</small></p>` : ''}
                ${data.processing_time ? `<p><small>Processing time: ${data.processing_time.toFixed(2)}s</small></p>` : ''}
            </div>
        `;
    } else if (!data.success) {
        // Display warning (no plates detected)
        resultsContent.innerHTML = `
            <div class="warning-result">
                <i class="fas fa-exclamation-circle"></i>
                <h4>No Plates Detected</h4>
                <p>Could not detect any license plates in the image.</p>
                ${data.message ? `<p><small>${data.message}</small></p>` : ''}
                ${data.processing_summary ? `
                    <div style="margin-top: 1rem;">
                        <p><small>Methods tried: ${data.processing_summary.detection_methods?.join(', ') || 'None'}</small></p>
                    </div>
                ` : ''}
            </div>
        `;
    } else {
        // Display success with enhanced results
        const processingSummary = data.processing_summary || {};
        const plates = data.plates || [];
        const imageAnalysis = data.image_analysis || {};
        
        let html = `
            <div class="success-result">
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4 style="margin: 0;">Processing Successful</h4>
                            <div class="result-id">ID: ${data.request_id || 'N/A'}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span class="quality-badge">
                            <i class="fas fa-star"></i> ${(data.quality_score || 0).toFixed(1)}% Quality
                        </span>
                        <span class="processing-time">
                            <i class="fas fa-clock"></i> ${processingSummary.total_time?.toFixed(2) || '0.00'}s
                        </span>
                    </div>
                </div>
                
                <!-- Processing Summary -->
                <div class="result-summary">
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="stat-value">${plates.length}</div>
                            <div class="stat-label">Plates Detected</div>
                        </div>
                        <div class="summary-stat">
                            <div class="stat-value">${(processingSummary.ocr_time || 0).toFixed(2)}s</div>
                            <div class="stat-label">OCR Time</div>
                        </div>
                        <div class="summary-stat">
                            <div class="stat-value">${(processingSummary.detection_time || 0).toFixed(2)}s</div>
                            <div class="stat-label">Detection Time</div>
                        </div>
                        <div class="summary-stat">
                            <div class="stat-value">${(data.quality_score || 0).toFixed(1)}%</div>
                            <div class="stat-label">Quality Score</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <div style="color: #94a3b8; margin-bottom: 0.5rem; font-size: 0.875rem;">
                            <i class="fas fa-cogs"></i> Methods Used
                        </div>
                        <div class="summary-methods">
                            ${processingSummary.detection_methods?.map(method => 
                                `<span class="method-badge">${method}</span>`
                            ).join('') || ''}
                            ${processingSummary.ocr_methods?.map(method => 
                                `<span class="method-badge">${method}</span>`
                            ).join('') || ''}
                        </div>
                    </div>
                </div>
        `;
        
        // Display plates if any
        if (plates.length > 0) {
            html += `
                <div class="plates-section">
                    <h5 class="plates-title">
                        <i class="fas fa-car"></i> Detected Plates (${plates.length})
                    </h5>
                    
                    <div class="plates-grid">
            `;
            
            plates.forEach((plate, index) => {
                const bestOcr = plate.best_ocr || {};
                const detection = plate.detection || {};
                const plateInfo = plate.plate_info || {};
                const ocrResults = plate.ocr_results || {};
                
                // Convert local file paths to HTTP URLs
                const croppedPath = plate.cropped_path ? convertLocalPathToUrl(plate.cropped_path) : '';
                const enhancedPath = plate.enhanced_path ? convertLocalPathToUrl(plate.enhanced_path) : '';
                
                html += `
                    <div class="plate-card">
                        <div class="plate-header">
                            <div class="plate-number">Plate ${index + 1}</div>
                            <div class="plate-confidence">${(bestOcr.confidence * 100 || 0).toFixed(1)}%</div>
                        </div>
                        
                        <div class="plate-body">
                            <div class="plate-ocr-result">
                                <div class="ocr-text">${bestOcr.text || 'No text detected'}</div>
                                <div class="ocr-engine">
                                    <i class="fas fa-microchip"></i> ${bestOcr.engine || 'Unknown'} 
                                    ${bestOcr.agreement_count ? `(${bestOcr.agreement_count} engines agree)` : ''}
                                </div>
                            </div>
                            
                            <div class="plate-details">
                                <div class="detail-item">
                                    <span class="detail-label">Detector</span>
                                    <span class="detail-value">${detection.detector || 'Unknown'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Confidence</span>
                                    <span class="detail-value">${(detection.confidence * 100 || 0).toFixed(1)}%</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Color</span>
                                    <span class="detail-value">${plateInfo.color_type || 'Unknown'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Quality</span>
                                    <span class="detail-value">${(plateInfo.quality_score * 100 || 0).toFixed(1)}%</span>
                                </div>
                            </div>
                            
                            <div class="plate-images">
                                <div class="plate-image">
                                    <div class="plate-image-label">Cropped</div>
                                    <img src="${croppedPath}" alt="Cropped plate ${index + 1}" 
                                         onerror="handleImageError(this, 'Cropped plate ${index + 1}')">
                                </div>
                                <div class="plate-image">
                                    <div class="plate-image-label">Enhanced</div>
                                    <img src="${enhancedPath}" alt="Enhanced plate ${index + 1}" 
                                         onerror="handleImageError(this, 'Enhanced plate ${index + 1}')">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // Display OCR engines comparison
        if (plates.length > 0 && plates[0].ocr_results) {
            const ocrResults = plates[0].ocr_results;
            const engines = Object.keys(ocrResults);
            
            if (engines.length > 0) {
                html += `
                    <div class="ocr-engines-section">
                        <h5 class="ocr-engines-title">
                            <i class="fas fa-chart-bar"></i> OCR Engine Comparison
                        </h5>
                        
                        <div class="ocr-engines-grid">
                `;
                
                engines.forEach(engine => {
                    const result = ocrResults[engine];
                    const isBest = plates[0].best_ocr?.engine?.includes(engine);
                    
                    html += `
                        <div class="ocr-engine-card ${isBest ? 'best' : ''}">
                            <div class="ocr-engine-header">
                                <div class="ocr-engine-name">${engine}</div>
                                <div class="ocr-confidence">${(result.confidence * 100 || 0).toFixed(1)}%</div>
                            </div>
                            <div class="ocr-engine-text">${result.text || 'No text detected'}</div>
                            ${isBest ? '<div style="color: #6366f1; font-size: 0.75rem;"><i class="fas fa-trophy"></i> Best result</div>' : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        }
        
        // Display image analysis
        if (imageAnalysis && Object.keys(imageAnalysis).length > 0) {
            html += `
                <div class="image-analysis-section">
                    <h5 class="analysis-title">
                        <i class="fas fa-chart-line"></i> Image Analysis
                    </h5>
                    
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="analysis-label">Image Quality</div>
                            <div class="analysis-value">${imageAnalysis.image_quality || 'Unknown'}</div>
                            <div class="analysis-score">
                                <div class="analysis-score-fill" style="width: ${(imageAnalysis.quality_score || 0)}%"></div>
                            </div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Lighting</div>
                            <div class="analysis-value">${imageAnalysis.lighting_condition || 'Unknown'}</div>
                            <div class="analysis-score">
                                <div class="analysis-score-fill" style="width: ${(imageAnalysis.lighting_score * 100 || 0)}%"></div>
                            </div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Vehicle Type</div>
                            <div class="analysis-value">${imageAnalysis.vehicle_type || 'Unknown'}</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">Country</div>
                            <div class="analysis-value">${imageAnalysis.country_code || 'Unknown'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Display visualization if available
        if (data.files?.visualization || (data.files?.cropped_plates && data.files.cropped_plates.length > 0)) {
            html += `
                <div class="visualization-section">
                    <h5 class="visualization-title">
                        <i class="fas fa-eye"></i> Visualizations
                    </h5>
                    
                    <div class="visualization-grid">
            `;
            
            if (data.files.visualization) {
                const vizUrl = data.files.visualization.startsWith('http') ? 
                              data.files.visualization : 
                              convertLocalPathToUrl(data.files.visualization);
                
                html += `
                    <div class="visualization-card">
                        <h5><i class="fas fa-search"></i> Detection Visualization</h5>
                        <div class="visualization-image">
                            <img src="${vizUrl}" alt="Detection visualization" 
                                 onerror="handleImageError(this, 'Detection visualization')">
                        </div>
                    </div>
                `;
            }
            
            if (data.files.cropped_plates && data.files.cropped_plates.length > 0) {
                html += `
                    <div class="visualization-card">
                        <h5><i class="fas fa-crop"></i> All Cropped Plates</h5>
                        <div class="visualization-image">
                            <div style="display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem;">
                `;
                
                data.files.cropped_plates.forEach((path, idx) => {
                    const plateUrl = path.startsWith('http') ? 
                                   path : 
                                   convertLocalPathToUrl(path);
                    
                    html += `
                        <div style="min-width: 100px; text-align: center;">
                            <img src="${plateUrl}" alt="Plate ${idx + 1}" 
                                 style="width: 100px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #475569;"
                                 onerror="handleImageError(this, 'Plate ${idx + 1}')">
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">Plate ${idx + 1}</div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // Display enhanced plates if available
        if (data.files?.enhanced_plates && data.files.enhanced_plates.length > 0) {
            html += `
                <div class="visualization-section">
                    <h5 class="visualization-title">
                        <i class="fas fa-magic"></i> Enhanced Plates
                    </h5>
                    
                    <div class="visualization-grid">
                        <div class="visualization-card">
                            <h5><i class="fas fa-crop"></i> All Enhanced Plates</h5>
                            <div class="visualization-image">
                                <div style="display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem;">
            `;
            
            data.files.enhanced_plates.forEach((path, idx) => {
                const plateUrl = path.startsWith('http') ? 
                               path : 
                               convertLocalPathToUrl(path);
                
                html += `
                    <div style="min-width: 100px; text-align: center;">
                        <img src="${plateUrl}" alt="Enhanced plate ${idx + 1}" 
                             style="width: 100px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #475569;"
                             onerror="handleImageError(this, 'Enhanced plate ${idx + 1}')">
                        <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">Enhanced ${idx + 1}</div>
                    </div>
                `;
            });
            
            html += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Display original image if available
        if (data.files?.original) {
            const originalUrl = data.files.original.startsWith('http') ? 
                              data.files.original : 
                              convertLocalPathToUrl(data.files.original);
            
            html += `
                <div class="visualization-section">
                    <h5 class="visualization-title">
                        <i class="fas fa-image"></i> Original Image
                    </h5>
                    
                    <div class="visualization-grid">
                        <div class="visualization-card">
                            <h5><i class="fas fa-file-image"></i> Uploaded Image</h5>
                            <div class="visualization-image">
                                <img src="${originalUrl}" alt="Original image" 
                                     style="max-width: 100%; max-height: 400px; border-radius: 4px;"
                                     onerror="handleImageError(this, 'Original image')">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Add action buttons
        html += `
                <div class="result-actions">
                    <button class="btn btn-primary" onclick="saveResult('${data.request_id || ''}')">
                        <i class="fas fa-save"></i> Save Result
                    </button>
                    <button class="btn btn-secondary" onclick="exportResult('${data.request_id || ''}')">
                        <i class="fas fa-download"></i> Export Results
                    </button>
                    <button class="btn btn-outline" onclick="downloadAllImages('${data.request_id || ''}', ${JSON.stringify(data.files || {})})">
                        <i class="fas fa-download"></i> Download All Images
                    </button>
                    <button class="btn btn-outline" onclick="processAnother()">
                        <i class="fas fa-redo"></i> Process Another
                    </button>
                </div>
            </div>
        `;
        
        resultsContent.innerHTML = html;
    }
    
    // Show results
    document.getElementById('results-loading').style.display = 'none';
    resultsContent.style.display = 'block';
}

// Helper function to convert local paths to URLs
function convertLocalPathToUrl(localPath) {
    if (!localPath) return '';
    
    // If it's already a URL, return it
    if (localPath.startsWith('http') || localPath.startsWith('/')) {
        return localPath;
    }
    
    // Extract filename from local path
    const pathParts = localPath.split(/[\\\/]/);
    const filename = pathParts[pathParts.length - 1];
    
    // Determine which folder it's in based on path patterns
    if (localPath.includes('outputs') || localPath.includes('viz_') || localPath.includes('plate_') || localPath.includes('enhanced_')) {
        return `/outputs/${filename}`;
    } else if (localPath.includes('uploads')) {
        return `/uploads/${filename}`;
    }
    
    // Default fallback
    return `/outputs/${filename}`;
}

// Helper function to handle image loading errors
function handleImageError(imgElement, imageName) {
    imgElement.style.display = 'none';
    const parent = imgElement.parentElement;
    parent.innerHTML = `
        <div style="padding: 2rem; color: #64748b; text-align: center;">
            <i class="fas fa-image fa-2x"></i>
            <div style="margin-top: 0.5rem;">${imageName} not available</div>
            <div style="font-size: 0.75rem; margin-top: 0.25rem;">Click to reload</div>
        </div>
    `;
    
    // Make it clickable to retry
    parent.style.cursor = 'pointer';
    parent.onclick = function() {
        imgElement.style.display = 'block';
        parent.innerHTML = '';
        parent.appendChild(imgElement);
        imgElement.src = imgElement.src + '?t=' + new Date().getTime(); // Add timestamp to bypass cache
    };
}

// Function to download all images
async function downloadAllImages(requestId, files) {
    if (!files || Object.keys(files).length === 0) {
        showNotification('No images to download', 'warning');
        return;
    }
    
    showNotification('Preparing images for download...', 'info');
    
    try {
        // Create a zip file
        const JSZip = window.JSZip;
        if (!JSZip) {
            // Load JSZip dynamically
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
        }
        
        const zip = new JSZip();
        let fileCount = 0;
        
        // Add visualization image
        if (files.visualization) {
            const vizUrl = files.visualization.startsWith('http') ? files.visualization : convertLocalPathToUrl(files.visualization);
            const vizBlob = await fetchImageBlob(vizUrl);
            if (vizBlob) {
                zip.file('visualization.jpg', vizBlob);
                fileCount++;
            }
        }
        
        // Add cropped plates
        if (files.cropped_plates && files.cropped_plates.length > 0) {
            const croppedFolder = zip.folder('cropped_plates');
            for (let i = 0; i < files.cropped_plates.length; i++) {
                const plateUrl = files.cropped_plates[i].startsWith('http') ? 
                               files.cropped_plates[i] : 
                               convertLocalPathToUrl(files.cropped_plates[i]);
                const plateBlob = await fetchImageBlob(plateUrl);
                if (plateBlob) {
                    croppedFolder.file(`plate_${i + 1}.jpg`, plateBlob);
                    fileCount++;
                }
            }
        }
        
        // Add enhanced plates
        if (files.enhanced_plates && files.enhanced_plates.length > 0) {
            const enhancedFolder = zip.folder('enhanced_plates');
            for (let i = 0; i < files.enhanced_plates.length; i++) {
                const plateUrl = files.enhanced_plates[i].startsWith('http') ? 
                               files.enhanced_plates[i] : 
                               convertLocalPathToUrl(files.enhanced_plates[i]);
                const plateBlob = await fetchImageBlob(plateUrl);
                if (plateBlob) {
                    enhancedFolder.file(`enhanced_${i + 1}.jpg`, plateBlob);
                    fileCount++;
                }
            }
        }
        
        // Add original image
        if (files.original) {
            const originalUrl = files.original.startsWith('http') ? files.original : convertLocalPathToUrl(files.original);
            const originalBlob = await fetchImageBlob(originalUrl);
            if (originalBlob) {
                zip.file('original.jpg', originalBlob);
                fileCount++;
            }
        }
        
        if (fileCount === 0) {
            showNotification('No images could be downloaded', 'error');
            return;
        }
        
        // Generate zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        
        // Download zip file
        const url = window.URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `plate-detection-${requestId || Date.now()}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification(`Downloaded ${fileCount} images successfully`, 'success');
        
    } catch (error) {
        console.error('Download error:', error);
        showNotification('Failed to download images: ' + error.message, 'error');
    }
}

// Helper function to fetch image as blob
async function fetchImageBlob(url) {
    try {
        const response = await fetch(url);
        if (response.ok) {
            return await response.blob();
        }
    } catch (error) {
        console.error('Failed to fetch image:', url, error);
    }
    return null;
}

// Helper function to load scripts dynamically
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

function displayError(error) {
    const resultsContent = document.getElementById('results-content');
    
    resultsContent.innerHTML = `
        <div class="error-result">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>Processing Error</h4>
            <p>${error.message || 'An unknown error occurred'}</p>
            <p style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="retryProcessing()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </p>
        </div>
    `;
    
    document.getElementById('results-loading').style.display = 'none';
    resultsContent.style.display = 'block';
}

function retryProcessing() {
    processImage();
}

function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}

function closeProcessingModal() {
    document.getElementById('processing-modal').style.display = 'none';
}

function resetForm() {
    // Clear all inputs
    clearPreview();
    document.getElementById('image-url').value = '';
    document.getElementById('url-preview').style.display = 'none';
    
    // Stop camera if running
    if (cameraStream) {
        stopCamera();
    }
    
    // Reset options to defaults
    document.getElementById('use-yolo').checked = true;
    document.getElementById('use-transformer').checked = false;
    document.getElementById('use-fallback').checked = true;
    document.getElementById('multi-scale').checked = true;
    document.getElementById('ocr-easyocr').checked = true;
    document.getElementById('ocr-tesseract').checked = true;
    document.getElementById('ocr-google').checked = false;
    document.getElementById('ocr-deep').checked = true;
    document.getElementById('preprocess').checked = true;
    document.getElementById('save-output').checked = true;
    document.getElementById('save-db').checked = true;
    document.getElementById('save-original').checked = true;
    
    // Hide results
    document.getElementById('results-section').style.display = 'none';
    
    // Reset processing state
    isProcessing = false;
    updateProcessButton();
    
    // Switch back to single tab
    switchTab('single');
    
    showNotification('Form reset successfully', 'info');
}

async function saveResult(resultId) {
    if (!resultId) {
        showNotification('No result to save', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/results/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: resultId })
        });
        
        if (response.ok) {
            showNotification('Result saved to database', 'success');
        } else {
            throw new Error('Failed to save result');
        }
    } catch (error) {
        showNotification('Failed to save result: ' + error.message, 'error');
    }
}

async function exportResult(resultId) {
    if (!resultId) {
        showNotification('No result to export', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/results/export?id=${resultId}&format=json`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plate-result-${resultId}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showNotification('Result exported successfully', 'success');
        } else {
            throw new Error('Failed to export result');
        }
    } catch (error) {
        showNotification('Failed to export result: ' + error.message, 'error');
    }
}

function processAnother() {
    resetForm();
}

// Drag and drop functionality
const dropzone = document.getElementById('dropzone');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropzone.classList.add('highlight');
}

function unhighlight() {
    dropzone.classList.remove('highlight');
}

dropzone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        handleFileUpload(files[0]);
    }
}

// Notification system
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        z-index: 10000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    `;
    
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
    notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
    
    document.body.appendChild(notification);
    
    // Add animation styles if not already present
    if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set up drag and drop
    if (dropzone) {
        dropzone.addEventListener('click', function() {
            document.getElementById('file-input').click();
        });
    }
    
    // Initialize file input
    const fileInput = document.getElementById('file-input');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
    }
    
    // Check system health
    checkSystemHealth();
});

// Check system health
async function checkSystemHealth() {
    try {
        const response = await fetch('/api/health');
        if (response.ok) {
            const data = await response.json();
            
            if (data.status === 'healthy') {
                console.log('✅ System is healthy and ready');
            } else if (data.status === 'degraded') {
                console.warn('⚠️ System is running in degraded mode');
                showNotification('System is running in degraded mode. Some features may not work optimally.', 'warning');
            } else {
                console.error('❌ System is unhealthy');
                showNotification('System is experiencing issues. Some features may not work.', 'error');
            }
        }
    } catch (error) {
        console.warn('⚠️ Could not check system health:', error);
    }
}
</script>
{% endblock %}